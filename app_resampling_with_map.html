<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.548">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Applied Machine Learning - Map across resamples</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./app_pca.html" rel="next">
<link href="./app_dummy_coding.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="book.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./review_midterm.html">Appendices</a></li><li class="breadcrumb-item"><a href="./app_resampling_with_map.html">Map across resamples</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Applied Machine Learning</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/jjcurtin/book_iaml" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Syllabus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./course_materials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Materials</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l01_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview of Machine Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l02_exploratory_data_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l03_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introduction to Regression Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l04_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Introduction to Classification Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l05_resampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Resampling Methods for Model Selection and Evaluation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l06_regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Regularization and Penalized Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l07_midterm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Midterm Exam</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l08_advanced_performance_metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Advanced Performance Metrics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l09_random_forest.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced Models: Decision Trees, Bagging Trees, and Random Forest</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l10_neural_networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced Models: Neural Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l11_explanation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Explanatory Approaches</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l12_nlp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Natural Language Processing: Text Processing and Feature Engineering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l13_applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Applications for Machine Learning: Synthesis and Concept Generalization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l14_ethics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Ethical Issues in Machine Learning Research and Applications</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l15_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Final Exams - Applications and Concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./review_midterm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Review Midterm Concepts Exam</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_terminology.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Key Terminology and Concepts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_dummy_coding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Novel Levels in Held-Out Set(s)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_resampling_with_map.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Map across resamples</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_pca.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Principal Components Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_keras.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installing Keras for Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Test</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#set-up" id="toc-set-up" class="nav-link active" data-scroll-target="#set-up">Set up</a></li>
  <li><a href="#using-map-to-replace-fit_resamples---step-x-step" id="toc-using-map-to-replace-fit_resamples---step-x-step" class="nav-link" data-scroll-target="#using-map-to-replace-fit_resamples---step-x-step">Using map() to replace fit_resamples() - step x step</a></li>
  <li><a href="#using-map-to-replace-fit_resamples---one-function" id="toc-using-map-to-replace-fit_resamples---one-function" class="nav-link" data-scroll-target="#using-map-to-replace-fit_resamples---one-function">Using map() to replace fit_resamples() - one function</a></li>
  <li><a href="#using-two-maps-to-replace-tune_grid" id="toc-using-two-maps-to-replace-tune_grid" class="nav-link" data-scroll-target="#using-two-maps-to-replace-tune_grid">Using two map()s to replace tune_grid()</a></li>
  <li><a href="#using-maps-to-do-nested-cv" id="toc-using-maps-to-do-nested-cv" class="nav-link" data-scroll-target="#using-maps-to-do-nested-cv">Using map()s to do nested cv</a></li>
  <li><a href="#final-notes---parallel-processing" id="toc-final-notes---parallel-processing" class="nav-link" data-scroll-target="#final-notes---parallel-processing">Final notes - parallel processing</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/jjcurtin/book_iaml/edit/main/app_resampling_with_map.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./review_midterm.html">Appendices</a></li><li class="breadcrumb-item"><a href="./app_resampling_with_map.html">Map across resamples</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Map across resamples</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><code>fit_resamples()</code> and <code>tune_grid()</code> are tidymodels functions that we use in combination with objects generated from a resampling function (e.g., <code>vfold_cv()</code>, <code>bootstraps()</code>, etc from the <code>rsample</code> package) to get held-out performance estimates for our models.</p>
<ul>
<li><p><code>fit_resamples()</code> and <code>tune_grid()</code> use looping under the hood to accomplish their goals. <code>fit_resamples()</code> loops over the splits generated by our resampling function to get held-out performance estiamtes for a single model configuration.</p></li>
<li><p><code>tune_grid()</code> also loops over these splits but includes an additional inner loop that loops over the values of our hyper-parameters in a hyper-parameter grid that we create.</p></li>
</ul>
<hr>
<p>In this appendix, we are going to re-create the functionality of <code>fit_resamples()</code> and <code>tune_grid()</code> using the <code>map()</code> function from the <code>purrr</code> package. This will help us understand how these functions work under the hood and give us a better understanding of how to use them. It will also give us an alternative way to do resampling if we need it.</p>
<p>Specifically, with respect to using resampling to get held-out performance estimates, we will</p>
<ul>
<li>Gain a better understanding of the resampling object that is returns from <code>bootstraps()</code> and <code>vfold_cv()</code></li>
<li>Make more transparent how these functions incorporate loops as part of their computations</li>
<li>Be able to reproduce these computations, manually for when we can’t use these functions directly.
<ul>
<li>This might be if we want to loop over model configurations that are not defined by differece in hyperparameters but instead by other characteristics (e.g., different recipes, different statistical algorithms).<br>
</li>
<li>We want to use an algorigthm that is not supported by tidymodels (e.g., we are developing deep neural networks outside of tidymodels by directly using the keras package)</li>
</ul></li>
<li>We want to do nested resampling (e.g., using <code>bootstraps()</code> to both select a best model configuration and evaluate that best configuration with the variance benefits that are offered by nested cv relative to using a single held out test set.</li>
</ul>
<hr>
<p>More generally, we will also gain a better understanding (and some code examples) of the use of list columns with iteration via <code>map()</code>.</p>
<ul>
<li>This has many other uses than just resampling.<br>
</li>
<li>Wickham has writting about this in more detail <a href="https://r4ds.had.co.nz/many-models.html">elsewhere</a>.</li>
</ul>
<hr>
<p>In this appendix, we will work through four separate examples that build in complexity</p>
<ul>
<li>First, we will reproduce <code>fit_resamples()</code> computations by using <code>map()</code> to loop over the splits and fit a single model to each split. We use separate independent <code>maps()</code> for each step</li>
<li>Next, we will do this again but by wrapping all the steps into one function and using a single call to <code>map()</code> to loop that function over the splits.</li>
<li>The third example, will reproduce <code>tune_grid()</code> by using two nested <code>map()</code>s to loop over the splits and the hyper-parameter grid.<br>
</li>
<li>The final example will demonstrate how to do nested resampling using <code>map()</code> Nested resampling includes both an outer and inner loop across different out and inner splits. There is also an innermost loop across values in a hyper-parameter grid (or any other grid that defines different model configurations)</li>
</ul>
<hr>
<section id="set-up" class="level2">
<h2 class="anchored" data-anchor-id="set-up">Set up</h2>
<p>Lets start all of these examples by….</p>
<p>Loading libraries</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Creating a simple data set that has 300 observationns and two predictors (<code>x1</code> and <code>x2</code>) and one outcome (<code>y</code>). The outcome is a linear combination of the two predictors with some noise added.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123456</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x1 =</span> <span class="fu">rnorm</span>(n_obs), <span class="at">x2 =</span> <span class="fu">rnorm</span>(n_obs), <span class="at">y =</span> <span class="dv">2</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span>x2 <span class="sc">+</span> <span class="fu">rnorm</span>(n_obs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Getting bootstrap resamples of d.&nbsp;</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>n_boots <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>resamples <span class="ot">&lt;-</span> <span class="fu">bootstraps</span>(d, <span class="at">times =</span> n_boots)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>bootstraps()</code></p>
<ul>
<li>Returns an object that two columns and <code>n_boots</code> (in this case 50) rows. Each row is a bootstrap sample of the data. The columns are:</li>
<li><code>splits</code> - contains a bootstrap sample of the data that includes held-in raw data and OOB held-out raw data subsamples</li>
<li><code>id</code> - name of the resample</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>resamples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># Bootstrap sampling 
# A tibble: 50 × 2
   splits            id         
   &lt;list&gt;            &lt;chr&gt;      
 1 &lt;split [300/115]&gt; Bootstrap01
 2 &lt;split [300/108]&gt; Bootstrap02
 3 &lt;split [300/108]&gt; Bootstrap03
 4 &lt;split [300/107]&gt; Bootstrap04
 5 &lt;split [300/112]&gt; Bootstrap05
 6 &lt;split [300/102]&gt; Bootstrap06
 7 &lt;split [300/112]&gt; Bootstrap07
 8 &lt;split [300/114]&gt; Bootstrap08
 9 &lt;split [300/115]&gt; Bootstrap09
10 &lt;split [300/117]&gt; Bootstrap10
# ℹ 40 more rows</code></pre>
</div>
</div>
<p>This resamples object is a tibble (as typical in the tidy framework).</p>
<ul>
<li>However, it uses “list columns” to hold the splits.<br>
</li>
<li>In a typical tibble, the individual cells in any column contain numeric or character data. However, this is not required. A column in a tibble is just a list and therefore, the cells can contain any type of object.<br>
</li>
<li>The cells for the <code>splits</code> column in this tibble contain splits, a special object created by functions in the <code>rsample</code> package that hold resampled datasets.</li>
</ul>
<p>We can extract the contents of one of these cells using the base R <code>[[]]</code> notation</p>
<ul>
<li>The first resample used the full 300 observations from d (the last value)</li>
<li>It make a bootstrap resample of 300 observations from d (the first value) that we can use as held-in data for training models</li>
<li>There are 115 OOB observations for this split that we can use as held-out data</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>resamples<span class="sc">$</span>splits[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Analysis/Assess/Total&gt;
&lt;300/115/300&gt;</code></pre>
</div>
</div>
<hr>
<p>We will also need a recipe to create features from our raw data. Here is a simple recipe that indicate that y will be models on all the other columns (<code>x1</code> and <code>x2</code>). We will not do any other feature engineering to keep this example simple.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We are now ready to start the first example</p>
</section>
<section id="using-map-to-replace-fit_resamples---step-x-step" class="level2">
<h2 class="anchored" data-anchor-id="using-map-to-replace-fit_resamples---step-x-step">Using map() to replace fit_resamples() - step x step</h2>
<p>In this first example, we will combine <code>map()</code> with the use of list columns to save all the intermediate products that are produced when fitting and evaluating a single model configuration for a simple linear regression across many (in this case 50) held-out sets created by bootstrapping.</p>
<p>To do this, we will need a function to fit linear models to held-in training data. We can use the typical tidymodels code here.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fit_lm <span class="ot">&lt;-</span> <span class="cf">function</span>(held_in) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linear_reg</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"lm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> held_in)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Then we use <code>map()</code> and list columns to save the individual steps for evaluating the model in each split/resample. The following steps are done for EACH resample using <code>map()</code> or <code>map2()</code></p>
<ul>
<li>Prep the recipe with held-in data (in <code>prep_recs</code> column)</li>
<li>Bake the recipe using <code>new_data = NULL</code> to get held-in features (in <code>held_ins</code>)</li>
<li>Bake the recipe using <code>new_data = assessment(split)</code> to get held-out features (in <code>held_outs</code>)</li>
<li>Fit the model using the held-in features (in <code>models</code>)</li>
<li>Get predictions using the model with the held-out features (in <code>predictions</code>)</li>
<li>Calculate the rmse of the model (in <code>rmses</code>)</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>resamples_ex1 <span class="ot">&lt;-</span> resamples <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prep_recs =</span> <span class="fu">map</span>(splits, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                         \(split) <span class="fu">prep</span>(rec, <span class="at">training =</span> <span class="fu">analysis</span>(split))),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">held_ins =</span> <span class="fu">map2</span>(resamples<span class="sc">$</span>splits, prep_recs, </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                         \(split, prep_rec) <span class="fu">bake</span>(prep_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">held_outs =</span> <span class="fu">map2</span>(resamples<span class="sc">$</span>splits, prep_recs, </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                          \(split, prep_rec) <span class="fu">bake</span>(prep_rec, </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">new_data =</span> <span class="fu">assessment</span>(split))),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">models =</span> <span class="fu">map</span>(held_ins, </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                      \(held_in) <span class="fu">fit_lm</span>(held_in)),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">predictions =</span> <span class="fu">map2</span>(models, held_outs, </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                            \(model, held_out) <span class="fu">predict</span>(model, held_out)<span class="sc">$</span>.pred),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">rmses =</span> <span class="fu">map2_dbl</span>(predictions, held_outs, </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                           \(pred, held_out) <span class="fu">rmse_vec</span>(held_out<span class="sc">$</span>y, pred)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>The pipline above creates a tibble with columns for each of the intermediate products and the rmse/error of the model in each resample.</p>
<ul>
<li>All but the last columns are list columns that can hold objects of any time (e.g., prepped recipes, data frames, model objects).<br>
</li>
<li>The final column is a double column that holds the numeric rmse of the model in each resample. That is why we used <code>map_dbl()</code> to create the rmses column.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>resamples_ex1 <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 50
Columns: 8
$ splits      &lt;list&gt; [&lt;boot_split[300 x 115 x 300 x 3]&gt;], [&lt;boot_split[300 x 1…
$ id          &lt;chr&gt; "Bootstrap01", "Bootstrap02", "Bootstrap03", "Bootstrap04"…
$ prep_recs   &lt;list&gt; [x1, x2, y, double, numeric, double, numeric, double, num…
$ held_ins    &lt;list&gt; [&lt;tbl_df[300 x 3]&gt;], [&lt;tbl_df[300 x 3]&gt;], [&lt;tbl_df[300 x …
$ held_outs   &lt;list&gt; [&lt;tbl_df[115 x 3]&gt;], [&lt;tbl_df[108 x 3]&gt;], [&lt;tbl_df[108 x …
$ models      &lt;list&gt; [NULL, ~NULL, ~NULL, regression, FALSE, stats, formula, f…
$ predictions &lt;list&gt; &lt;1.38587470, 2.84334628, -2.07435584, 1.24941793, -0.0569…
$ rmses       &lt;dbl&gt; 0.9826968, 0.9380291, 1.0127994, 0.9929520, 0.9849202, 0.9…</code></pre>
</div>
</div>
<hr>
<p>We can now look at rmses across the 50 bootstraps. For example, we can make a histogram using ggplot from the errors column in the fits tibble</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>resamples_ex1 <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(rmses)) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="app_resampling_with_map_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And we can summarize the min, max, mean, median and stdev of the error column in the fits tibble</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>resamples_ex1 <span class="sc">|&gt;</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">min =</span> <span class="fu">min</span>(rmses), </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">max =</span> <span class="fu">max</span>(rmses), </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> <span class="fu">mean</span>(rmses), </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(rmses),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">std_dev =</span> <span class="fu">sd</span>(rmses))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
      n   min   max  mean median std_dev
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
1    50 0.876  1.12 0.997  0.989  0.0557</code></pre>
</div>
</div>
<hr>
<p>Easy peasy!</p>
<ul>
<li>This first example has demonstrated the use of <code>map()</code> and list columns, which has many uses.</li>
<li>This first example also makes clear what <code>fit_resamples()</code> is doing.</li>
<li>It also gives you an alternative workflow in case you can’t use <code>fit_resamples()</code>.
<ul>
<li>This might occur if you are training deep neural networks with keras directly.</li>
<li>In that instance, you might use the <code>fit()</code> function from keras to fit the model and then use <code>predict()</code> to get predictions. But you could still use the functions from the <code>rsample</code> package to get a resampled object (e.g., using <code>bootstraps()</code>) and you could use performance metrics (e.g., <code>rmse_vec()</code>) from the yardstick package.</li>
</ul></li>
</ul>
<p>But remember, if you can (and in most instances, you can), it is easier to still using <code>fit_resamples()</code> to get your held-out performance estimates.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>resamples_tidy_ex1 <span class="ot">&lt;-</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linear_reg</span>() <span class="sc">|&gt;</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"lm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit_resamples</span>(<span class="at">preprocessor =</span> rec, </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">resamples =</span> resamples, </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">metrics =</span> <span class="fu">metric_set</span>(rmse))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>resamples_tidy_ex1 <span class="sc">|&gt;</span> </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  .metric .estimator  mean     n std_err .config             
  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard   0.997    50 0.00788 Preprocessor1_Model1</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>resamples_tidy_ex1 <span class="sc">|&gt;</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>(<span class="at">summarize =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 50 × 5
   id          .metric .estimator .estimate .config             
   &lt;chr&gt;       &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
 1 Bootstrap01 rmse    standard       0.983 Preprocessor1_Model1
 2 Bootstrap02 rmse    standard       0.938 Preprocessor1_Model1
 3 Bootstrap03 rmse    standard       1.01  Preprocessor1_Model1
 4 Bootstrap04 rmse    standard       0.993 Preprocessor1_Model1
 5 Bootstrap05 rmse    standard       0.985 Preprocessor1_Model1
 6 Bootstrap06 rmse    standard       0.947 Preprocessor1_Model1
 7 Bootstrap07 rmse    standard       1.00  Preprocessor1_Model1
 8 Bootstrap08 rmse    standard       1.06  Preprocessor1_Model1
 9 Bootstrap09 rmse    standard       1.05  Preprocessor1_Model1
10 Bootstrap10 rmse    standard       0.981 Preprocessor1_Model1
# ℹ 40 more rows</code></pre>
</div>
</div>
</section>
<section id="using-map-to-replace-fit_resamples---one-function" class="level2">
<h2 class="anchored" data-anchor-id="using-map-to-replace-fit_resamples---one-function">Using map() to replace fit_resamples() - one function</h2>
<p>If we wanted to generate the held-out error using resampling but didnt need/want the intermediate products, we could wrap all the steps in one function and just map that single function.</p>
<ul>
<li>We might do this if we are working with big datasets and saving all the intermediate products requires too much memory.</li>
<li>Of course, we could also blend the this example with the previous example to save some but not all the intermediate products.</li>
</ul>
<hr>
<p>Here is a function that takes a split and a recipe and returns the rmse of the model fit to the held-in data and evaluated on the held-out data. It does all the steps we did in the previous example but in one function. We will use this function to replace all the intermediate steps in the previous example.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fit_and_eval <span class="ot">&lt;-</span> <span class="cf">function</span>(split, rec) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prep the recipe with held-in data</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  prep_rec <span class="ot">&lt;-</span> <span class="fu">prep</span>(rec, <span class="at">training =</span> <span class="fu">analysis</span>(split))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bake the recipe using new_data = NULL to pull out the held-in features</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  held_in <span class="ot">&lt;-</span> <span class="fu">bake</span>(prep_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bake the recipe using new_data = assessment(split) to get held-out features</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  held_out <span class="ot">&lt;-</span> <span class="fu">bake</span>(prep_rec, <span class="at">new_data =</span> <span class="fu">assessment</span>(split))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fit the model using the held-in features</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"lm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> held_in)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get predictions using the model with the held-out features</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, held_out)<span class="sc">$</span>.pred</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the accuracy of the model</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse_vec</span>(held_out<span class="sc">$</span>y, pred)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Now map this function over the splits to get a vector of rmse. Same results, but not saving intermediate steps by using one function.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>resamples_ex2 <span class="ot">&lt;-</span> resamples <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">errors =</span> <span class="fu">map_dbl</span>(splits, \(split) <span class="fu">fit_and_eval</span>(split, rec)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is what the resamples_ex2 tibble now looks like</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>resamples_ex2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># Bootstrap sampling 
# A tibble: 50 × 3
   splits            id          errors
   &lt;list&gt;            &lt;chr&gt;        &lt;dbl&gt;
 1 &lt;split [300/115]&gt; Bootstrap01  0.983
 2 &lt;split [300/108]&gt; Bootstrap02  0.938
 3 &lt;split [300/108]&gt; Bootstrap03  1.01 
 4 &lt;split [300/107]&gt; Bootstrap04  0.993
 5 &lt;split [300/112]&gt; Bootstrap05  0.985
 6 &lt;split [300/102]&gt; Bootstrap06  0.947
 7 &lt;split [300/112]&gt; Bootstrap07  1.00 
 8 &lt;split [300/114]&gt; Bootstrap08  1.06 
 9 &lt;split [300/115]&gt; Bootstrap09  1.05 
10 &lt;split [300/117]&gt; Bootstrap10  0.981
# ℹ 40 more rows</code></pre>
</div>
</div>
<hr>
<p>And here we demo getting overall held-out performance details across the 50 bootstraps.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>resamples_ex2 <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">min =</span> <span class="fu">min</span>(errors), </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">max =</span> <span class="fu">max</span>(errors), </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> <span class="fu">mean</span>(errors), </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(errors),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">std_dev =</span> <span class="fu">sd</span>(errors))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
      n   min   max  mean median std_dev
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
1    50 0.876  1.12 0.997  0.989  0.0557</code></pre>
</div>
</div>
</section>
<section id="using-two-maps-to-replace-tune_grid" class="level2">
<h2 class="anchored" data-anchor-id="using-two-maps-to-replace-tune_grid">Using two map()s to replace tune_grid()</h2>
<p>Now we can make this a bit more complicated by adding a grid of hyperparameters to tune.</p>
<ul>
<li>Lets keep it simple and tune only k in a knn model.<br>
</li>
<li>To tune k, we would normally use <code>tune_grid()</code> but we can do it again with two loops using <code>map()</code>.<br>
</li>
<li>We use an outer <code>map()</code> to loop over the resamples (as we did in the last two examples) and an inner <code>map()</code> to loop over the values of k</li>
</ul>
<p>Lets start by setting up a grid of values of k to tune over.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>grid_k <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">neighbors =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>, <span class="dv">15</span>, <span class="dv">18</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>We will use a single function to repeatedly fit and eval over our grid of parameters.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>eval_grid <span class="ot">&lt;-</span> <span class="cf">function</span>(split, rec, grid_k) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get held-in and held-out features for split </span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we calculate features inside the function where we fit all models across the grid </span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># because we want to make sure we only need to prep and bake the recipe once</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># per split.  Otherwise, we would waste a lot of computational time.</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  prep_rec <span class="ot">&lt;-</span> <span class="fu">prep</span>(rec, <span class="at">training =</span> <span class="fu">analysis</span>(split))</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  held_in <span class="ot">&lt;-</span> <span class="fu">bake</span>(prep_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  held_out <span class="ot">&lt;-</span> <span class="fu">bake</span>(prep_rec, <span class="at">new_data =</span> <span class="fu">assessment</span>(split))</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># function to fit and eval model for a specific k using held-in/held-out</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for this split</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  fit_eval <span class="ot">&lt;-</span> <span class="cf">function</span>(k, held_in, held_out) {</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nearest_neighbor</span>(<span class="at">neighbors =</span> k) <span class="sc">|&gt;</span>   </span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">|&gt;</span>   </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> held_in)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, held_out)<span class="sc">$</span>.pred</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lets put k and rmse in a tibble and return that for each split </span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">k =</span> k, </span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>           <span class="at">rmse =</span> <span class="fu">rmse_vec</span>(held_out<span class="sc">$</span>y, pred))</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop through grid_k and fit/eval model for each k </span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is the inner loop from tune_grid()</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use list_rbind() to bind the separate rows for each tibble into one larger tibble</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>  grid_k<span class="sc">$</span>neighbors <span class="sc">|&gt;</span> </span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(\(k) <span class="fu">fit_eval</span>(k, held_in, held_out)) <span class="sc">|&gt;</span> </span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Now we map this function over the 50 bootstrap splits.</p>
<ul>
<li>This is the outer loop from <code>tune_grid()</code>.<br>
</li>
<li><code>eval_grid()</code> will return a tibble with rows for each value of k. We will save one tibble for each split in a list column called `rmses``.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>resamples_ex3 <span class="ot">&lt;-</span> resamples <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rmses =</span> <span class="fu">map</span>(splits, </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>              \(split) <span class="fu">eval_grid</span>(split, rec, grid_k)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>The <code>rmses</code> column contains the rmse for each value of k for each split/resample in a tibble. Each tibble has 6 rows (one for each k) and 2 columns (k and rmse).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>resamples_ex3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># Bootstrap sampling 
# A tibble: 50 × 3
   splits            id          rmses           
   &lt;list&gt;            &lt;chr&gt;       &lt;list&gt;          
 1 &lt;split [300/115]&gt; Bootstrap01 &lt;tibble [6 × 2]&gt;
 2 &lt;split [300/108]&gt; Bootstrap02 &lt;tibble [6 × 2]&gt;
 3 &lt;split [300/108]&gt; Bootstrap03 &lt;tibble [6 × 2]&gt;
 4 &lt;split [300/107]&gt; Bootstrap04 &lt;tibble [6 × 2]&gt;
 5 &lt;split [300/112]&gt; Bootstrap05 &lt;tibble [6 × 2]&gt;
 6 &lt;split [300/102]&gt; Bootstrap06 &lt;tibble [6 × 2]&gt;
 7 &lt;split [300/112]&gt; Bootstrap07 &lt;tibble [6 × 2]&gt;
 8 &lt;split [300/114]&gt; Bootstrap08 &lt;tibble [6 × 2]&gt;
 9 &lt;split [300/115]&gt; Bootstrap09 &lt;tibble [6 × 2]&gt;
10 &lt;split [300/117]&gt; Bootstrap10 &lt;tibble [6 × 2]&gt;
# ℹ 40 more rows</code></pre>
</div>
</div>
<p>Lets take a look at one of these tibbles to make this structure clearer. The same tibble format is saved for all fifty bootstrap splits (with different values for <code>rmse</code> of course!)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>resamples_ex3<span class="sc">$</span>rmses[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
      k  rmse
  &lt;dbl&gt; &lt;dbl&gt;
1     3  1.51
2     6  1.47
3     9  1.47
4    12  1.52
5    15  1.56
6    18  1.61</code></pre>
</div>
</div>
<hr>
<p>We can <code>unnest()</code> the <code>rmses</code> column to get a tibble with one row for each k value in each resample.</p>
<ul>
<li><code>unnest()</code> is used frequently when a list column contains tibbles and you want to combine those tibbles into more traditional tibble without the list column.<br>
</li>
<li>No need to display the original splits column so we will select it out.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>resamples_ex3 <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(rmses) <span class="sc">|&gt;</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>splits) <span class="sc">|&gt;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 300 × 3
   id              k  rmse
   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
 1 Bootstrap01     3  1.51
 2 Bootstrap01     6  1.47
 3 Bootstrap01     9  1.47
 4 Bootstrap01    12  1.52
 5 Bootstrap01    15  1.56
 6 Bootstrap01    18  1.61
 7 Bootstrap02     3  1.31
 8 Bootstrap02     6  1.25
 9 Bootstrap02     9  1.25
10 Bootstrap02    12  1.27
11 Bootstrap02    15  1.29
12 Bootstrap02    18  1.30
13 Bootstrap03     3  1.48
14 Bootstrap03     6  1.46
15 Bootstrap03     9  1.48
16 Bootstrap03    12  1.50
17 Bootstrap03    15  1.52
18 Bootstrap03    18  1.54
19 Bootstrap04     3  1.41
20 Bootstrap04     6  1.34
21 Bootstrap04     9  1.31
22 Bootstrap04    12  1.32
23 Bootstrap04    15  1.35
24 Bootstrap04    18  1.38
25 Bootstrap05     3  1.51
26 Bootstrap05     6  1.43
27 Bootstrap05     9  1.41
28 Bootstrap05    12  1.42
29 Bootstrap05    15  1.44
30 Bootstrap05    18  1.44
# ℹ 270 more rows</code></pre>
</div>
</div>
<hr>
<p>We can pipe this unnested tibble into a <code>group_by()</code> and <code>summarize()</code> to get the median (or mean) across resamples and then arrange to find the best k</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>resamples_ex3 <span class="sc">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(rmses) <span class="sc">|&gt;</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>splits) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(k) <span class="sc">|&gt;</span> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_rmse =</span> <span class="fu">mean</span>(rmse)) <span class="sc">|&gt;</span> </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mean_rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
      k     n mean_rmse
  &lt;dbl&gt; &lt;int&gt;     &lt;dbl&gt;
1     9    50      1.34
2    12    50      1.35
3     6    50      1.36
4    15    50      1.36
5    18    50      1.38
6     3    50      1.42</code></pre>
</div>
</div>
<hr>
<p>The example makes it clear that using resampling to tune a grid of hyperparameters is just a matter of looping over the resamples in an outer loop and looping over a grid of hyperparameters in an inner loop.</p>
<p>You might use this approach</p>
<ul>
<li>if you wanted to select among model configurations that different by something other than hyper-parameters (e.g., different recipes, different statistical algorithms).<br>
</li>
<li>Or if you wanted to fit models not supported by tidymodels.</li>
</ul>
<hr>
<p>But of course, when you can use it, using <code>tune_grid()</code> is easier because it takes care of the nested looping internally.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>resamples_tidy_ex3 <span class="ot">&lt;-</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nearest_neighbor</span>(<span class="at">neighbors =</span> <span class="fu">tune</span>()) <span class="sc">|&gt;</span>   </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">|&gt;</span>   </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(<span class="at">preprocessor =</span> rec, </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">resamples =</span> resamples, </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">grid =</span> grid_k, </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">metrics =</span> <span class="fu">metric_set</span>(rmse))</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>resamples_tidy_ex3 <span class="sc">|&gt;</span> </span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">|&gt;</span> </span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  neighbors .metric .estimator  mean     n std_err .config             
      &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1         9 rmse    standard    1.34    50  0.0184 Preprocessor1_Model3
2        12 rmse    standard    1.35    50  0.0202 Preprocessor1_Model4
3         6 rmse    standard    1.36    50  0.0165 Preprocessor1_Model2
4        15 rmse    standard    1.36    50  0.0216 Preprocessor1_Model5
5        18 rmse    standard    1.38    50  0.0225 Preprocessor1_Model6
6         3 rmse    standard    1.42    50  0.0161 Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
<section id="using-maps-to-do-nested-cv" class="level2">
<h2 class="anchored" data-anchor-id="using-maps-to-do-nested-cv">Using map()s to do nested cv</h2>
<p>Now lets do the most complicated version of this. Nested resampling involves looping over outer splits where the held out data are test sets used to evaluate best model configurations for each outer split and the inner loop makes validation sets that are used to select the best model configuration for each outer fold. However, if we are tuning a grid of hyperparameters, there is even a further nested loop inside the inner resampling loop to get performance metrics for each value of the hyperparameter in the validation sets.</p>
<p><code>rsample</code> supports creating a nested resampling object.</p>
<ul>
<li>You can specify different resampling for the inner and outer loops.<br>
</li>
<li>k-fold for the outer loop and bootstraps for the inner loop is a common choice.</li>
<li>However, neither <code>fit_resamples()</code> or <code>tune_grid()</code> support nested resampling. So we will always need to use nested <code>map()</code> to do this ourselves.</li>
</ul>
<hr>
<p>First, lets make the nested resampling object and explore it a bit</p>
<ul>
<li>We will use 5-fold cv for the outer loop</li>
<li>We will use 10 bootstraps for the inner loop</li>
<li>These numbers were selected only to make the computations faster. You may need more splits.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>resamples_nested <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nested_cv</span>(<span class="at">outside =</span> <span class="fu">vfold_cv</span>(<span class="at">v =</span> <span class="dv">5</span>), <span class="at">inside =</span> <span class="fu">bootstraps</span>(<span class="at">times =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Lets take a look at it.</p>
<ul>
<li>It has five rows for each of the five outer splits. The outer splits are the k-folds.</li>
<li>The inner_resamples column contains the inner splits associated with each outer k-fold split. Each inner split is a bootstrap resample with 10 bootstraps.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>resamples_nested</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># Nested resampling:
#  outer: 5-fold cross-validation
#  inner: Bootstrap sampling
# A tibble: 5 × 3
  splits           id    inner_resamples
  &lt;list&gt;           &lt;chr&gt; &lt;list&gt;         
1 &lt;split [240/60]&gt; Fold1 &lt;boot [10 × 2]&gt;
2 &lt;split [240/60]&gt; Fold2 &lt;boot [10 × 2]&gt;
3 &lt;split [240/60]&gt; Fold3 &lt;boot [10 × 2]&gt;
4 &lt;split [240/60]&gt; Fold4 &lt;boot [10 × 2]&gt;
5 &lt;split [240/60]&gt; Fold5 &lt;boot [10 × 2]&gt;</code></pre>
</div>
</div>
<p>Lets look a little more carefully at this structure because its critical to understanding nested cv.</p>
<ul>
<li>Below we pull out and look at the first outer k-fold split.</li>
<li>The total sample size is 300 and the outer k-fold split has 60 observations held-out to eventually use as a test set and 240 held-in that will eventually be used as training data when we train models in the outer loop to get our final performance metrics for best values of k. We will also use these held-in data in the inner loop.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>resamples_nested<span class="sc">$</span>splits[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Analysis/Assess/Total&gt;
&lt;240/60/300&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I prefer to work with this resampled objects using base R notation</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># however you could do the same using piped tidy code</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># resamples_nested |&gt; </span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   slice(1) |&gt; </span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   pull(splits)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now look below at the inner resamples for the first outer k-fold split.</p>
<ul>
<li>For each outer k-fold split, we take the held-in data (240 observations in this case) and split it further, using the inner resampling method (10 bootstraps here).</li>
<li>Notice that each of the 10 bootstraps associated with the first outer k-fold split have 240 observation (because we used the held-in data from that outer k-fold split). These bootstrap resamples will be used as training data for the inner loop of nested. We will train models with various values of k with these data</li>
<li>Notice also that each of these 10 boostraps have held-out (OOB) observations that will be used as validation sets for the inner loop of nested. We will use these held-out validation sets to calculate performance metrics for the models with different value of k. This will let us select the best value of k for each outer split.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>resamples_nested<span class="sc">$</span>inner_resamples[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># Bootstrap sampling 
# A tibble: 10 × 2
   splits           id         
   &lt;list&gt;           &lt;chr&gt;      
 1 &lt;split [240/87]&gt; Bootstrap01
 2 &lt;split [240/86]&gt; Bootstrap02
 3 &lt;split [240/80]&gt; Bootstrap03
 4 &lt;split [240/76]&gt; Bootstrap04
 5 &lt;split [240/89]&gt; Bootstrap05
 6 &lt;split [240/93]&gt; Bootstrap06
 7 &lt;split [240/90]&gt; Bootstrap07
 8 &lt;split [240/92]&gt; Bootstrap08
 9 &lt;split [240/93]&gt; Bootstrap09
10 &lt;split [240/87]&gt; Bootstrap10</code></pre>
</div>
</div>
<hr>
<p>Now that we have a resamples object to use for nested cv, lets get some functions together to calculate rmses for inner validation sets and outer test sets</p>
<p>We will need a function again that takes a split, uses the recipe to get held-in/held-out features, and then fits and evaluates a model for each value of k in the grid. This is the exact same function as we used earlier (because we are using knn again). We include it below again for your review.</p>
<ul>
<li>We will use this function twice.</li>
<li>In the inner loop of our nested cv, we will map this function over all 10 of our bootstraps associated with an outer split.</li>
<li>In the outer loop of our nested cv, we will map this function over all 5 of our outer splits using the best value of k that was identified for each outer split using its respective 10 bootstraps.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>eval_grid <span class="ot">&lt;-</span> <span class="cf">function</span>(split, rec, grid_k) {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get held-in and held-out features for split </span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  prep_rec <span class="ot">&lt;-</span> <span class="fu">prep</span>(rec, <span class="at">training =</span> <span class="fu">analysis</span>(split))</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  held_in <span class="ot">&lt;-</span> <span class="fu">bake</span>(prep_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  held_out <span class="ot">&lt;-</span> <span class="fu">bake</span>(prep_rec, <span class="at">new_data =</span> <span class="fu">assessment</span>(split))</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># function fit fit and eval model for a specific lambda and resample</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  fit_eval <span class="ot">&lt;-</span> <span class="cf">function</span>(k, held_in, held_out) {</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nearest_neighbor</span>(<span class="at">neighbors =</span> k) <span class="sc">|&gt;</span>   </span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">|&gt;</span>   </span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> held_in)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, held_out)<span class="sc">$</span>.pred</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lets put k and rmse in a tibble and return that for each split </span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">k =</span> k, </span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">rmse =</span> <span class="fu">rmse_vec</span>(held_out<span class="sc">$</span>y, pred))</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop through grid_k and fit/eval model for each k </span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is the inner loop</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use list_rbind() to bind the separate rows for each tibble into one larger tibble</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>  grid_k<span class="sc">$</span>neighbors <span class="sc">|&gt;</span> </span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(\(k) <span class="fu">fit_eval</span>(k, held_in, held_out)) <span class="sc">|&gt;</span> </span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>To loop eval_grid over the 10 bootstraps in the nested cv inner loop, we will need another simple function that applies our <code>eval_grid()</code> over each bootstrap within a set of 10 and binds the results into a single tibble.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>bind_bootstraps <span class="ot">&lt;-</span> <span class="cf">function</span>(bootstraps, rec, grid_k) {</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  bootstraps<span class="sc">$</span>splits <span class="sc">|&gt;</span>  </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(\(bootstrap_split) <span class="fu">eval_grid</span>(bootstrap_split, rec, grid_k)) <span class="sc">|&gt;</span> </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Now we are ready to get performance metrics for each k in <code>grid_k</code> for each of the inner 10 bootstraps in each of the five outer k-folds splits. Remember that <code>bind_bootstraps()</code> just calls <code>eval_grid()</code> for each of the 10 bootstraps in the inner loop and binds the results.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>resamples_nested_ex4 <span class="ot">&lt;-</span> resamples_nested <span class="sc">|&gt;</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inner_rmses =</span> <span class="fu">map</span>(inner_resamples, </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>                          \(inner_resample) <span class="fu">bind_bootstraps</span>(inner_resample, </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                                                            rec, </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                                                            grid_k)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Lets look at what we just added to our resamples object</p>
<ul>
<li>We now have a tibble with 60 rows and 2 columns associated with each set of 10 inner bootstrap splits.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>resamples_nested_ex4 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># Nested resampling:
#  outer: 5-fold cross-validation
#  inner: Bootstrap sampling
# A tibble: 5 × 4
  splits           id    inner_resamples inner_rmses      
  &lt;list&gt;           &lt;chr&gt; &lt;list&gt;          &lt;list&gt;           
1 &lt;split [240/60]&gt; Fold1 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;
2 &lt;split [240/60]&gt; Fold2 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;
3 &lt;split [240/60]&gt; Fold3 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;
4 &lt;split [240/60]&gt; Fold4 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;
5 &lt;split [240/60]&gt; Fold5 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;</code></pre>
</div>
</div>
<p>If we look at one of them, we see</p>
<ul>
<li>The 60 rows are because we have 10 boostraps for each of the 6 values of k in the grid. So 10 * 6 = 60 rmses</li>
<li>we have columns for k and rmse</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>resamples_nested_ex4<span class="sc">$</span>inner_rmses[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 60 × 2
       k  rmse
   &lt;dbl&gt; &lt;dbl&gt;
 1     3  1.52
 2     6  1.54
 3     9  1.58
 4    12  1.62
 5    15  1.65
 6    18  1.68
 7     3  1.77
 8     6  1.70
 9     9  1.69
10    12  1.70
# ℹ 50 more rows</code></pre>
</div>
</div>
<hr>
<p>We now need to calculate the best k for each of the sets of 10 boostraps (associated with one outer k-fold split). To do this, we average the 10 rmses together for each value of k and then choose the k with the lowest rmse. We will write a function to do this because we can then map that function over each of the sets of 10 bootstraps associated with each outer split.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>get_best_k <span class="ot">&lt;-</span> <span class="cf">function</span>(rmses) {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  rmses <span class="sc">|&gt;</span>  </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(k) <span class="sc">|&gt;</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_rmse =</span> <span class="fu">mean</span>(rmse)) <span class="sc">|&gt;</span> </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(mean_rmse) <span class="sc">|&gt;</span> </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(k)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And then map it across the sets of rmses for each outer k-fold splilt.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>resamples_nested_ex4 <span class="ot">&lt;-</span> resamples_nested_ex4 <span class="sc">|&gt;</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">best_k =</span> <span class="fu">map_dbl</span>(inner_rmses, \(rmses) <span class="fu">get_best_k</span>(rmses)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we have determined the best value of k for each of the 5 outer folds.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>resamples_nested_ex4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># Nested resampling:
#  outer: 5-fold cross-validation
#  inner: Bootstrap sampling
# A tibble: 5 × 5
  splits           id    inner_resamples inner_rmses       best_k
  &lt;list&gt;           &lt;chr&gt; &lt;list&gt;          &lt;list&gt;             &lt;dbl&gt;
1 &lt;split [240/60]&gt; Fold1 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;      6
2 &lt;split [240/60]&gt; Fold2 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;     12
3 &lt;split [240/60]&gt; Fold3 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;     12
4 &lt;split [240/60]&gt; Fold4 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;      6
5 &lt;split [240/60]&gt; Fold5 &lt;boot [10 × 2]&gt; &lt;tibble [60 × 2]&gt;      9</code></pre>
</div>
</div>
<hr>
<p>We can now move up to the outer k-fold splits. We will use the best k for each outer fold to fit a model using the held-in data from the outer fold and then evaluate that model using the held-out test data. Those test data were NEVER used before so the will allow us to see how that model with a best value of k (selected by bootstrap resampling) performs in new data</p>
<p>We can reuse the <code>eval_grid()</code> function we used before to fit and evaluate the model using the held-in data and the held-out test data. But now we just use one value of k, the one that was best for each fold</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>resamples_nested_ex4 <span class="ot">&lt;-</span> resamples_nested_ex4 <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">test_rmse =</span> <span class="fu">map2</span>(splits, best_k, </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                               \(split, k) <span class="fu">eval_grid</span>(split, rec, <span class="fu">tibble</span>(<span class="at">neighbors =</span> k))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>We can pull the one row tibbles out of this final column and bind them together to get a tibble with one row for each outer fold. We have retained the best value of k for each fold for our information (these don’t need to be the same for each k-fold split).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>resamples_nested_ex4<span class="sc">$</span>test_rmse <span class="sc">|&gt;</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">outer_fold =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(resamples_nested_ex4<span class="sc">$</span>test_rmse)) <span class="sc">|&gt;</span> </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(outer_fold)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  outer_fold     k  rmse
       &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
1          1     6  1.23
2          2    12  1.58
3          3    12  1.28
4          4     6  1.21
5          5     9  1.06</code></pre>
</div>
</div>
<p>If we want to know the true best k to use when we train a final model to implement using all our data, we need select it by using our inner reasampling method (10 boostraps) with all our data.</p>
<p>We could then train our final implementation model by fitting a model to all our data using this value of k.</p>
</section>
<section id="final-notes---parallel-processing" class="level2">
<h2 class="anchored" data-anchor-id="final-notes---parallel-processing">Final notes - parallel processing</h2>
<p>All of these examples were done without the use of parallel processing. <code>fit_resamples()</code> and <code>tune_grid()</code> can use a parallel backend if you set it up.</p>
<ul>
<li>You could modify our code to implement <code>map()</code> in parallel using <code>future_map()</code> from the <code>furrr</code> package.</li>
<li>For our <code>fit_resamples()</code> examples, there is only one <code>map()</code> or several independent ones. None are nested. Switch them all to <code>future_map()</code>.</li>
<li>For our <code>tune_grid()</code> example, there are two nested <code>maps()</code>. In most instances, you will want to switch the outer loop <code>map()</code> to <code>future_map()</code> and leave the inner <code>map()</code> as is.</li>
<li>For our nested example, there are three nested <code>map()</code>s. In most instances, you will want to switch that outermost <code>map()</code> (across outer splits) to <code>future_map()</code> and leave the inner two <code>map()</code>s as is. - See our <a href="https://jjcurtin.github.io/book_dwvt/parallel_processing.html">post</a> on setting up parallel backends for more info on how to do that</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./app_dummy_coding.html" class="pagination-link  aria-label=" novel="" levels="" in="" held-out="" set(s)"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Novel Levels in Held-Out Set(s)</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./app_pca.html" class="pagination-link" aria-label="Principal Components Analysis">
        <span class="nav-page-text">Principal Components Analysis</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/jjcurtin/book_iaml/edit/main/app_resampling_with_map.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>