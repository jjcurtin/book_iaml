{"title":"Appendix 2: Simulations of Model Performance Bias and Variance by Resampling Techniques","markdown":{"yaml":{"output":"html_document","editor_options":{"chunk_output_type":"console"}},"headingText":"Appendix 2: Simulations of Model Performance Bias and Variance by Resampling Techniques","containsRefs":false,"markdown":"\n\n\n\n\n## General Setup\n\nLoad libraries\n```{r}\n#| message: false\n\nlibrary(tidyverse)\nlibrary(tidymodels)\n\ntheme_set(theme_classic())\n```\n\n## DGP\nFunction to generate `n_obs` of simulated observations\n\n* DGP is linear on all `x` + normal error with sd = `irr_err`\n* y is simple sum such that all coefficients = 1\n* features are correlated based on `sigma`\n```{r}\nsimulate_DGP <- function (n_obs, n_features, irr_err, mu, sigma){\n\n  x <- MASS::mvrnorm(n_obs, mu = mu, Sigma = sigma) |> \n    magrittr::set_colnames(str_c(\"x\", 1:n_features)) |> \n    as_tibble()\n  \n  x |> \n     mutate(y = rowSums(t(t(x)*b)) + rnorm(n_obs, \n                                        mean = 0, \n                                        sd = irr_err))\n}\n```\n\n\n## Simulation settings\n```{r}\nn_sims <- 1000  # number of simulations\nn_obs <- 300 # number of observations\n\nn_features <- 20\nmu <- rep(0, n_features)\nsigma <- matrix(.3, nrow = n_features, ncol = n_features)\ndiag(sigma) <- 1\nirr_err <- 10\nb <- rep(0.5, n_features) # no b0 so set to 0\n  \nset.seed(123456)\n# first call so that we can set up recipe\ndf <- simulate_DGP(n_obs, n_features, irr_err, mu, sigma) \nrec <- recipe(y ~ ., data = df)\n\nrmse_combined = NULL  # to store RMSE for all methods\n```\n\n\n## Get simulation dfs\n\n```{r}\ndfs <- rep(n_obs, n_sims) |>\n  map(\\(n_obs) simulate_DGP(n_obs, n_features, irr_err, mu, sigma))\n```\n\n\n## What is the TRUE model performance\n\nThe irreducible error is set to 10 but our model will have some reducible error too so the true performance of our model will be worse than 10\n\n* The DGP is linear \n* but we only have `r n_obs` observations \n* and we have 20 features\n\nLets fit many models of n = `r n_obs` (the size of our final model) and assess performance in really big samples of new data (ah the luxury of simulated data!)\n```{r}\n\n# models based on full n for each simulation run\nmodels <- dfs |> \n  map(\\(df) linear_reg() |> fit(y ~ ., data = df))\n\n# big samples of held out data for high precision assessment of models\n# 1 for each model\nouts <- rep(10000, n_sims) |> \n  map(\\(n_obs) simulate_DGP(n_obs, n_features, irr_err, mu, sigma))\n\n# list of predictions for out from each model\npreds <- map2(models, outs, \\(model, out) predict(model, out))\n\n# get mean rmse in big held out data set for 1000 full n models\n# should be very precise\nrmse_true <- map2_dbl(outs, preds, \\(out, pred)  rmse_vec(out$y,\n                                                      pred$.pred)) |> \n  mean()\n\nmessage(\"True RMSE = \", rmse_true)\n```\n\nParallel processing for resampling methods with `fit_resamples()`\n```{r}\ncl <- parallel::makePSOCKcluster(parallel::detectCores(logical = FALSE))\ndoParallel::registerDoParallel(cl)\n```\n\n## Validation set\n\n### 80/20 split\n\n\nHere we simulate repeated use of the validation set approach to assess our model performance\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) validation_split(df, prop = .80)) |>   # validation set split\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarise = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"val_set_80\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n## 50/50 split\n\nHere we simulate repeated use of the validation set approach to assess our model performance\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) validation_split(df, prop = .50)) |>   # validation set split\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"val_set_50\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n## K-fold\n\n### Simple 5-fold\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) vfold_cv(df, v = 5)) |>   # 5-fold\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"5-fold\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n### Simple 10-fold\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) vfold_cv(df, v = 10)) |>   # 10-fold\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"10-fold\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n\n### 3x 10-Fold\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) vfold_cv(df, v = 10, repeats = 3)) |>   # 3x10-fold\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"3x10-fold\") |> # label results in df\n  bind_rows(rmse_combined)\n```\n\n\n\n## Bootstrap Resampling\n\n### 10 resamples\n\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) bootstraps(df, times = 10)) |>   # 10 boots\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"boot_10\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n### 100 resamples\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) bootstraps(df, times = 100)) |>   # 100 boots\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"boot_100\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n### 1000 resamples\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) bootstraps(df, times = 1000)) |>   # 1000 boots\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"boot_1000\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n\n## Summarize\n```{r a102-summary}\nrmse_combined |> \n  group_by(method) |> \n  summarize(rmse_mean = mean(mean),\n            rmse_sd = sd(mean),\n            n = n())\n```\n\n\n##  Plot sampling distributions\n```{r a102-plot}\nrmse_combined |> \n  ggplot(aes(x = mean, color = method)) + \n  geom_density() +\n  geom_vline(aes(xintercept = mean(rmse_true)),\n            color = \"blue\", linetype = \"dashed\", linewidth = 1)\n```\n","srcMarkdownNoYaml":"\n\n# Appendix 2: Simulations of Model Performance Bias and Variance by Resampling Techniques\n\n\n\n## General Setup\n\nLoad libraries\n```{r}\n#| message: false\n\nlibrary(tidyverse)\nlibrary(tidymodels)\n\ntheme_set(theme_classic())\n```\n\n## DGP\nFunction to generate `n_obs` of simulated observations\n\n* DGP is linear on all `x` + normal error with sd = `irr_err`\n* y is simple sum such that all coefficients = 1\n* features are correlated based on `sigma`\n```{r}\nsimulate_DGP <- function (n_obs, n_features, irr_err, mu, sigma){\n\n  x <- MASS::mvrnorm(n_obs, mu = mu, Sigma = sigma) |> \n    magrittr::set_colnames(str_c(\"x\", 1:n_features)) |> \n    as_tibble()\n  \n  x |> \n     mutate(y = rowSums(t(t(x)*b)) + rnorm(n_obs, \n                                        mean = 0, \n                                        sd = irr_err))\n}\n```\n\n\n## Simulation settings\n```{r}\nn_sims <- 1000  # number of simulations\nn_obs <- 300 # number of observations\n\nn_features <- 20\nmu <- rep(0, n_features)\nsigma <- matrix(.3, nrow = n_features, ncol = n_features)\ndiag(sigma) <- 1\nirr_err <- 10\nb <- rep(0.5, n_features) # no b0 so set to 0\n  \nset.seed(123456)\n# first call so that we can set up recipe\ndf <- simulate_DGP(n_obs, n_features, irr_err, mu, sigma) \nrec <- recipe(y ~ ., data = df)\n\nrmse_combined = NULL  # to store RMSE for all methods\n```\n\n\n## Get simulation dfs\n\n```{r}\ndfs <- rep(n_obs, n_sims) |>\n  map(\\(n_obs) simulate_DGP(n_obs, n_features, irr_err, mu, sigma))\n```\n\n\n## What is the TRUE model performance\n\nThe irreducible error is set to 10 but our model will have some reducible error too so the true performance of our model will be worse than 10\n\n* The DGP is linear \n* but we only have `r n_obs` observations \n* and we have 20 features\n\nLets fit many models of n = `r n_obs` (the size of our final model) and assess performance in really big samples of new data (ah the luxury of simulated data!)\n```{r}\n\n# models based on full n for each simulation run\nmodels <- dfs |> \n  map(\\(df) linear_reg() |> fit(y ~ ., data = df))\n\n# big samples of held out data for high precision assessment of models\n# 1 for each model\nouts <- rep(10000, n_sims) |> \n  map(\\(n_obs) simulate_DGP(n_obs, n_features, irr_err, mu, sigma))\n\n# list of predictions for out from each model\npreds <- map2(models, outs, \\(model, out) predict(model, out))\n\n# get mean rmse in big held out data set for 1000 full n models\n# should be very precise\nrmse_true <- map2_dbl(outs, preds, \\(out, pred)  rmse_vec(out$y,\n                                                      pred$.pred)) |> \n  mean()\n\nmessage(\"True RMSE = \", rmse_true)\n```\n\nParallel processing for resampling methods with `fit_resamples()`\n```{r}\ncl <- parallel::makePSOCKcluster(parallel::detectCores(logical = FALSE))\ndoParallel::registerDoParallel(cl)\n```\n\n## Validation set\n\n### 80/20 split\n\n\nHere we simulate repeated use of the validation set approach to assess our model performance\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) validation_split(df, prop = .80)) |>   # validation set split\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarise = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"val_set_80\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n## 50/50 split\n\nHere we simulate repeated use of the validation set approach to assess our model performance\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) validation_split(df, prop = .50)) |>   # validation set split\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"val_set_50\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n## K-fold\n\n### Simple 5-fold\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) vfold_cv(df, v = 5)) |>   # 5-fold\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"5-fold\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n### Simple 10-fold\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) vfold_cv(df, v = 10)) |>   # 10-fold\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"10-fold\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n\n### 3x 10-Fold\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) vfold_cv(df, v = 10, repeats = 3)) |>   # 3x10-fold\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"3x10-fold\") |> # label results in df\n  bind_rows(rmse_combined)\n```\n\n\n\n## Bootstrap Resampling\n\n### 10 resamples\n\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) bootstraps(df, times = 10)) |>   # 10 boots\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"boot_10\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n### 100 resamples\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) bootstraps(df, times = 100)) |>   # 100 boots\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"boot_100\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n### 1000 resamples\n```{r}\nrmse_combined <- dfs |> \n  map(\\(df) bootstraps(df, times = 1000)) |>   # 1000 boots\n  map(\\(split) linear_reg() |> fit_resamples(resamples = split, \n                                              preprocessor = rec,\n                                              metrics = metric_set(rmse))) |> \n  map(\\(fits) collect_metrics(fits, summarize = TRUE)) |> \n  list_rbind() |> \n  mutate(method = \"boot_1000\") |>       # label results in df\n  bind_rows(rmse_combined)\n```\n\n\n## Summarize\n```{r a102-summary}\nrmse_combined |> \n  group_by(method) |> \n  summarize(rmse_mean = mean(mean),\n            rmse_sd = sd(mean),\n            n = n())\n```\n\n\n##  Plot sampling distributions\n```{r a102-plot}\nrmse_combined |> \n  ggplot(aes(x = mean, color = method)) + \n  geom_density() +\n  geom_vline(aes(xintercept = mean(rmse_true)),\n            color = \"blue\", linetype = \"dashed\", linewidth = 1)\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":"html_document","warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"show","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":3,"css":["book.css"],"output-file":"app_model_performance_simulations.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.551","bibliography":["refs.bib"],"callout-icon":false,"editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}