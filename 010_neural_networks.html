<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Applied Machine Learning - 10&nbsp; Advanced Models: Neural Networks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./011_explanation.html" rel="next">
<link href="./009_random_forest.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="book.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./010_neural_networks.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced Models: Neural Networks</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Applied Machine Learning</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/jjcurtin/book_iaml" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Syllabus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./001_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview of Machine Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./002_exploratory_data_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./003_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introduction to Regression Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./004_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Introduction to Classification Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./005_resampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Resampling Methods for Model Selection and Evaluation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./006_regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Regularization and Penalized Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./007_midterm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Midterm Exam</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./008_advanced_performance_metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Advanced Performance Metrics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./009_random_forest.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced Models: Decision Trees, Bagging Trees, and Random Forest</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./010_neural_networks.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced Models: Neural Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./011_explanation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Explanatory Approaches</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./012_nlp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Natural Language Processing: Text Processing and Feature Engineering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./013_applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Applications for Machine Learning: Synthesis and Concept Generalization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./014_ethics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Ethical Issues in Machine Learning Research and Applications</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./015_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Final Exam and Project</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_terminology.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Key Terminology and Concepts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_dummy_coding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Novel Levels in Held-Out Set(s)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_keras.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Installing Keras for Neural Networks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_model_performance_simulations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Appendix 2: Simulations of Model Performance Bias and Variance by Resampling Techniques</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_shap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Appendix 3: Understanding Shapley Values from SHAP</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_bootstrapping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Appendix 4: Bootstrapping Standard Errors &amp; Confidence Intervals</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Test</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview-of-unit" id="toc-overview-of-unit" class="nav-link active" data-scroll-target="#overview-of-unit"><span class="header-section-number">10.1</span> Overview of Unit</a>
  <ul class="collapse">
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives"><span class="header-section-number">10.1.1</span> Learning Objectives</a></li>
  <li><a href="#readings" id="toc-readings" class="nav-link" data-scroll-target="#readings"><span class="header-section-number">10.1.2</span> Readings</a></li>
  <li><a href="#lecture-videos" id="toc-lecture-videos" class="nav-link" data-scroll-target="#lecture-videos"><span class="header-section-number">10.1.3</span> Lecture Videos</a></li>
  <li><a href="#coding-assignment" id="toc-coding-assignment" class="nav-link" data-scroll-target="#coding-assignment"><span class="header-section-number">10.1.4</span> Coding Assignment</a></li>
  </ul></li>
  <li><a href="#introduction-to-nerual-networks-with-keras-in-r" id="toc-introduction-to-nerual-networks-with-keras-in-r" class="nav-link" data-scroll-target="#introduction-to-nerual-networks-with-keras-in-r"><span class="header-section-number">10.2</span> Introduction to Nerual Networks with Keras in R</a></li>
  <li><a href="#setting-up-our-environment" id="toc-setting-up-our-environment" class="nav-link" data-scroll-target="#setting-up-our-environment"><span class="header-section-number">10.3</span> Setting up our Environment</a></li>
  <li><a href="#the-mnist-dataset" id="toc-the-mnist-dataset" class="nav-link" data-scroll-target="#the-mnist-dataset"><span class="header-section-number">10.4</span> The MNIST dataset</a></li>
  <li><a href="#fitting-neural-networks" id="toc-fitting-neural-networks" class="nav-link" data-scroll-target="#fitting-neural-networks"><span class="header-section-number">10.5</span> Fitting Neural Networks</a></li>
  <li><a href="#dealing-with-overfitting" id="toc-dealing-with-overfitting" class="nav-link" data-scroll-target="#dealing-with-overfitting"><span class="header-section-number">10.6</span> Dealing with Overfitting</a>
  <ul class="collapse">
  <li><a href="#regularization-or-weight-decay" id="toc-regularization-or-weight-decay" class="nav-link" data-scroll-target="#regularization-or-weight-decay"><span class="header-section-number">10.6.1</span> Regularization or Weight Decay</a></li>
  <li><a href="#dropout" id="toc-dropout" class="nav-link" data-scroll-target="#dropout"><span class="header-section-number">10.6.2</span> Dropout</a></li>
  <li><a href="#number-of-epochs-and-early-stopping" id="toc-number-of-epochs-and-early-stopping" class="nav-link" data-scroll-target="#number-of-epochs-and-early-stopping"><span class="header-section-number">10.6.3</span> Number of Epochs and Early Stopping</a></li>
  </ul></li>
  <li><a href="#using-resampling-to-select-best-model-configuration" id="toc-using-resampling-to-select-best-model-configuration" class="nav-link" data-scroll-target="#using-resampling-to-select-best-model-configuration"><span class="header-section-number">10.7</span> Using Resampling to Select Best Model Configuration</a></li>
  <li><a href="#other-details" id="toc-other-details" class="nav-link" data-scroll-target="#other-details"><span class="header-section-number">10.8</span> Other Details</a></li>
  <li><a href="#discussion-notes" id="toc-discussion-notes" class="nav-link" data-scroll-target="#discussion-notes"><span class="header-section-number">10.9</span> Discussion Notes</a>
  <ul class="collapse">
  <li><a href="#announcements" id="toc-announcements" class="nav-link" data-scroll-target="#announcements"><span class="header-section-number">10.9.1</span> Announcements</a></li>
  <li><a href="#keras-vs-nnet" id="toc-keras-vs-nnet" class="nav-link" data-scroll-target="#keras-vs-nnet"><span class="header-section-number">10.9.2</span> keras vs nnet</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">10.9.3</span> Overview</a></li>
  <li><a href="#activation-functions" id="toc-activation-functions" class="nav-link" data-scroll-target="#activation-functions"><span class="header-section-number">10.9.4</span> Activation functions</a></li>
  <li><a href="#addressing-overfitting" id="toc-addressing-overfitting" class="nav-link" data-scroll-target="#addressing-overfitting"><span class="header-section-number">10.9.5</span> Addressing overfitting</a></li>
  <li><a href="#autoencoders" id="toc-autoencoders" class="nav-link" data-scroll-target="#autoencoders"><span class="header-section-number">10.9.6</span> Autoencoders</a></li>
  <li><a href="#comparison-of-statistical-algorithms" id="toc-comparison-of-statistical-algorithms" class="nav-link" data-scroll-target="#comparison-of-statistical-algorithms"><span class="header-section-number">10.9.7</span> Comparison of statistical algorithms</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/jjcurtin/book_iaml/edit/main/010_neural_networks.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced Models: Neural Networks</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview-of-unit" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="overview-of-unit"><span class="header-section-number">10.1</span> Overview of Unit</h2>
<section id="learning-objectives" class="level3" data-number="10.1.1">
<h3 data-number="10.1.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">10.1.1</span> Learning Objectives</h3>
<ul>
<li>What are neural networks</li>
<li>Types of neural networks</li>
<li>Neural network architecture
<ul>
<li>layers and units</li>
<li>weights and biases</li>
<li>activation functions</li>
<li>cost functions</li>
<li>optimization
<ul>
<li>epochs</li>
<li>batches</li>
<li>learning rate</li>
</ul></li>
</ul></li>
<li>How to fit 3 layer MLPs in tidymodels using Keras</li>
</ul>
<hr>
</section>
<section id="readings" class="level3" data-number="10.1.2">
<h3 data-number="10.1.2" class="anchored" data-anchor-id="readings"><span class="header-section-number">10.1.2</span> Readings</h3>
<ul>
<li><a href="http://neuralnetworksanddeeplearning.com/chap1.html">Neural Networks and Deep Learning, Chapter 1: Using neural networks to recognize handwritten digits</a></li>
</ul>
<p>Post questions to the readings channel in Slack</p>
</section>
<section id="lecture-videos" class="level3" data-number="10.1.3">
<h3 data-number="10.1.3" class="anchored" data-anchor-id="lecture-videos"><span class="header-section-number">10.1.3</span> Lecture Videos</h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=aircAruvnKk&amp;list=PLZHQObOWTQDNU6R1_67000Dx_ZCJB-3pi&amp;index=1&amp;t">Lecture 1: But what is a Neural Network?</a> ~ 19 mins</li>
<li><a href="https://www.youtube.com/watch?v=IHZwWFHWa-w&amp;list=PLZHQObOWTQDNU6R1_67000Dx_ZCJB-3pi&amp;index=2&amp;t">Lecture 2: Gradient descent, how neural networks learn</a> ~ 21 mins</li>
<li><a href="https://www.youtube.com/watch?v=Ilg3gGewQ5U&amp;list=PLZHQObOWTQDNU6R1_67000Dx_ZCJB-3pi&amp;index=3&amp;t">Lecture 3: What is backpropagation really doing?</a> ~ 13 mins</li>
<li><a href="https://www.youtube.com/watch?v=tIeHLnjs5U8&amp;list=PLZHQObOWTQDNU6R1_67000Dx_ZCJB-3pi&amp;index=4&amp;t">Optional Lecture 4: Backpropagation calculus</a> ~ 10 mins</li>
<li><a href="https://mediaspace.wisc.edu/media/iaml+10-5/1_uqw3f0o9">Lecture 5: Introduction and the MNIST dataset</a> ~ 14 mins</li>
<li><a href="https://mediaspace.wisc.edu/media/iaml+unit+10-6/1_sv7eicou">Lecture 6: Fitting neural networks in tidymodels with Keras</a> ~ 18 mins</li>
<li><a href="https://mediaspace.wisc.edu/media/iaml+unit+10-7/1_ulfnye8s">Lecture 7: Addressing overfitting - Intro and L2</a> ~ 5 mins</li>
<li><a href="https://mediaspace.wisc.edu/media/iaml+unit+10-8/1_4k4cf1aj">Lecture 8: Addressing overfitting - Dropout</a> ~ 4 mins</li>
<li><a href="https://mediaspace.wisc.edu/media/iaml+unit+10-9/1_5dlsj34t">Lecture 9: Addressing overfitting - Early stopping</a> ~ 8 mins</li>
<li><a href="https://mediaspace.wisc.edu/media/iaml+unit+10-10/1_i448a6ta">Lecture 10: Selecting model configurations and final remarks</a> ~ 8 mins</li>
</ul>
<p>Post questions to the video-lectures channel in Slack</p>
<hr>
</section>
<section id="coding-assignment" class="level3" data-number="10.1.4">
<h3 data-number="10.1.4" class="anchored" data-anchor-id="coding-assignment"><span class="header-section-number">10.1.4</span> Coding Assignment</h3>
<ul>
<li>wine quality datasets: <a href="application_assignments/unit_10/wine_quality_trn.csv">training</a>; <a href="application_assignments/unit_10/wine_quality_test.csv">test</a></li>
<li><a href="https://raw.githubusercontent.com/jjcurtin/book_iaml/main/application_assignments/unit_10/hw_unit_10_neural_nets.qmd">qmd shell</a></li>
<li><a href="https://dionysus.psych.wisc.edu/iaml/key_unit_10_neural_nets.html">solution</a></li>
</ul>
<p>Post questions to application-assignments Slack channel</p>
<p>Submit the application assignment <a href="https://canvas.wisc.edu/courses/395546/assignments/2187685">here</a> and complete the <a href="https://canvas.wisc.edu/courses/395546/quizzes/514045">unit quiz</a> by 8 pm on Wednesday, April 3rd</p>
<hr>
</section>
</section>
<section id="introduction-to-nerual-networks-with-keras-in-r" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="introduction-to-nerual-networks-with-keras-in-r"><span class="header-section-number">10.2</span> Introduction to Nerual Networks with Keras in R</h2>
<p>We will be using the <code>keras</code> engine to fit our neural networks in R.</p>
<p>The <code>keras</code> <a href="https://cran.r-project.org/web/packages/keras/index.html">package</a> provides an <a href="https://keras.rstudio.com/">R Interface</a> to the <a href="https://keras.io/">Keras API in Python</a>.</p>
<hr>
<p>From the website:</p>
<ul>
<li><p>Keras is a high-level neural networks API developed with a focus on <strong>enabling fast experimentation</strong>. Being able to go from idea to result with the least possible delay is key to doing good research.</p></li>
<li><p>Keras has the following key features:</p>
<ul>
<li>Allows the same code to run on CPU or on GPU, seamlessly.</li>
<li><strong>User-friendly API</strong> - which makes it easy to quickly prototype deep learning models.</li>
<li>Built-in support for basic multi-layer perceptrons, convolutional networks (for computer vision), recurrent networks (for sequence processing), and any combination of both.</li>
<li>Supports arbitrary network architectures: multi-input or multi-output models, layer sharing, model sharing, etc. This means that Keras is appropriate for building essentially any deep learning model, from a memory network to a neural Turing machine.</li>
</ul></li>
</ul>
<hr>
<p>Keras is actually a wrapper around an even more extensive open source platform, <a href="https://www.tensorflow.org/">TensorFlow</a>, which has also been ported to the <a href="https://tensorflow.rstudio.com/">R environment</a></p>
<ul>
<li><p>TensorFlow is an end-to-end open source platform for machine learning. It has a comprehensive, flexible ecosystem of tools, libraries and community resources that lets researchers push the state-of-the-art in ML and developers easily build and deploy ML powered applications.</p></li>
<li><p>TensorFlow was originally developed by researchers and engineers working on the Google Brain Team within Google’s Machine Intelligence research organization for the purposes of conducting machine learning and deep neural networks research</p></li>
</ul>
<hr>
<p>If you are serious about focusing primarily or exclusively on neural networks, you will probably work directly within Keras in R or Python. However, tidymodels gives us access to 3 layer (single hidden layer) MLP neural networks through the <code>keras</code> engine. This allows us to fit simple (but still powerful) neural networks using all the tools (and code/syntax) that you already know. Yay!<br>
<br>
If you plan to use Keras directly in R, you might start with this <a href="https://www.manning.com/books/deep-learning-with-r?utm_source=google&amp;utm_medium=shopping&amp;utm_campaign=shopping1&amp;gclid=Cj0KCQjwo-aCBhC-ARIsAAkNQivtssXhY1RdFiYXSwu8eRWRXLUqveHkzyhdJU48W-jTU7O-qeKmONsaAmePEALw_wcB">book</a>. I’ve actually found it useful even in thinking about how to interface with Keras through tidymodels.</p>
<hr>
<p>Getting tidymodels configured to use the <code>keras</code> engine can take a little bit of upfront effort.<br>
<br>
We provide <a href="https://jjcurtin.github.io/book_iaml/app_keras.html">an appendix</a> to guide you through this process<br>
<br>
If you havent already set this up, please do so immediately so that you can reach out to us for support if you need it<br>
<br>
Once you have completed this one-time installation, you can now use the <code>keras</code> engine through tidymodels like any other engine. No need to do anything different from your normal tidymodeling workflow.</p>
<hr>
<p>You should also know that Keras is configured to use GPUs rather than CPU (GPUs allow for highly parallel fitting of neural networks).</p>
<ul>
<li>However, it works fine with just a CPU as well.<br>
</li>
<li>It will generate some errors to tell you that you aren’t set up with a GPU (and then it will tell you to ignore those error messages).</li>
<li>This is an instance where you can ignore the messages!</li>
</ul>
<hr>
</section>
<section id="setting-up-our-environment" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="setting-up-our-environment"><span class="header-section-number">10.3</span> Setting up our Environment</h2>
<p>Now lets start fresh</p>
<ul>
<li>We load our normal environment including source files, parallel processing and cache support if we plan to use it (code not displayed)</li>
<li>keras will work with R without loading it or other packages (beyond what we always load). However, there will be some function conflicts.
<ul>
<li>So we will load keras and exclude the conflict</li>
<li>We also need to load magrittr and exclude two of its conflicting functions</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras, <span class="at">exclude =</span> <span class="st">"get_weights"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr, <span class="at">exclude =</span> <span class="fu">c</span>(<span class="st">"set_names"</span>, <span class="st">"extract"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="the-mnist-dataset" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="the-mnist-dataset"><span class="header-section-number">10.4</span> The MNIST dataset</h2>
<p>The <a href="https://en.wikipedia.org/wiki/MNIST_database">MNIST database</a> (Modified National Institute of Standards and Technology database) is a large database of handwritten digits that is commonly used for training and testing in the field of machine learning.<br>
<br>
It consists of two sets:</p>
<ul>
<li>There are 60,000 images from 250 people in train</li>
<li>There are 10,000 images from a different 250 people in test (from different people than in train)</li>
</ul>
<hr>
<p>Each observation in the datasets represent a single image and its label</p>
<ul>
<li>Each image is a 28 X 28 grid of pixels = 784 predictors (x1 - x784)</li>
<li>Each label is the actual value (0-9; y). We will treat it as categorical because we are trying to identify each number “category”, predicting a label of “4” when the image is a “5” is just as bad as predicting “9”</li>
</ul>
<hr>
<p>Let’s start by reading train and test sets</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_data, <span class="st">"mnist_train.csv.gz"</span>),</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">col_types =</span> <span class="fu">cols</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">factor</span>(y, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">labels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 60000   785</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data_test <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_data, <span class="st">"mnist_test.csv"</span>),</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">col_types =</span> <span class="fu">cols</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">factor</span>(y, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">labels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>data_test <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10000   785</code></pre>
</div>
</div>
<hr>
<p>Here is some very basic info on the outcome distribution</p>
<ul>
<li>in train</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> <span class="fu">tab</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   y         n   prop
   &lt;fct&gt; &lt;int&gt;  &lt;dbl&gt;
 1 0      5923 0.0987
 2 1      6742 0.112 
 3 2      5958 0.0993
 4 3      6131 0.102 
 5 4      5842 0.0974
 6 5      5421 0.0904
 7 6      5918 0.0986
 8 7      6265 0.104 
 9 8      5851 0.0975
10 9      5949 0.0992</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> <span class="fu">plot_bar</span>(<span class="st">"y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/unnamed-chunk-5-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<ul>
<li>in test</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>data_test<span class="sc">|&gt;</span> <span class="fu">tab</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   y         n   prop
   &lt;fct&gt; &lt;int&gt;  &lt;dbl&gt;
 1 0       980 0.098 
 2 1      1135 0.114 
 3 2      1032 0.103 
 4 3      1010 0.101 
 5 4       982 0.0982
 6 5       892 0.0892
 7 6       958 0.0958
 8 7      1028 0.103 
 9 8       974 0.0974
10 9      1009 0.101 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>data_test <span class="sc">|&gt;</span> <span class="fu">plot_bar</span>(<span class="st">"y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/unnamed-chunk-7-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Let’s look at some of the images. We will need a function to display these images. We will use <code>as.cimg()</code> from the <code>imager</code> package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>display_image <span class="ot">&lt;-</span> <span class="cf">function</span>(data){</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Displaying: "</span>, data<span class="sc">$</span>y)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">|&gt;</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>y) <span class="sc">|&gt;</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="at">use.names =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    imager<span class="sc">::</span><span class="fu">as.cimg</span>(<span class="at">x =</span> <span class="dv">28</span>, <span class="at">y =</span> <span class="dv">28</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">axes =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>Observations 1, 3, 10, and 100 in training set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Displaying: 5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Displaying: 4</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Displaying: 4</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Displaying: 1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>And here is the first observation in test set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>data_test <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Displaying: 7</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Let’s understand the individual predictors a bit more</p>
<ul>
<li>Each predictor is a pixel in the 28 X 28 grid for the image</li>
<li>Pixel intensity is coded for intensity in the range from 0 (black) to 255 (white)</li>
<li>First 28 variables are the top row of 28 pixels</li>
<li>Next 28 variables are the second row of 28 pixels</li>
<li>There are 28 rows of 28 predictors total (784 predictors)</li>
</ul>
<hr>
<ul>
<li>Lets understand this by changing values for individual predictors</li>
<li>Here is the third image again</li>
</ul>
<p><span class="red">What will happen to the image if I change the value of predictor <code>x25</code> to 255</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Displaying: 4</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<ul>
<li>Change the <code>x25</code> to 255</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x25 =</span> <span class="dv">255</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Displaying: 4</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br>
<br>
<span class="red">What will happen to the image if I change the value of predictor <code>x29</code> to 255</span></p>
<hr>
<ul>
<li>Change the <code>x29</code> to 255</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x29 =</span> <span class="dv">255</span>) <span class="sc">|&gt;</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Displaying: 4</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/u11-mnist-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><span class="red">What will happen to the image if I change the value of predictor <code>x784</code> to 255</span></p>
<hr>
<ul>
<li>Change the <code>x784</code> to 255</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>data_trn <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x784 =</span> <span class="dv">255</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_image</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Displaying: 4</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="010_neural_networks_files/figure-html/u11-mnist-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="fitting-neural-networks" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="fitting-neural-networks"><span class="header-section-number">10.5</span> Fitting Neural Networks</h2>
<p>Let’s train some models to understand some basics about neural networks and the use of Keras within tidymodels</p>
<ul>
<li><p>We will fit some configurations in the full training set and evaluate their performance in test</p></li>
<li><p>We are NOT using test to select among configurations (it wouldn’t be a true test set then) but only for instructional purposes.</p></li>
<li><p>We will start with an absolute minimal recipe and mostly defaults for the statistical algorithm</p></li>
<li><p>We will build up to more complex (and better) configurations</p></li>
<li><p>We will end with a demonstration of the use of the single validation set approach to select among model configurations</p></li>
</ul>
<hr>
<p>Let’s start with a minimal recipe</p>
<ul>
<li>10 level categorical outcome as factor</li>
<li>Will be used to establish 10 output neurons</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>rec_min <span class="ot">&lt;-</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> data_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>Here are feature matrices for train and test using this recipe</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>rec_min_prep <span class="ot">&lt;-</span> rec_min <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data_trn)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>feat_trn <span class="ot">&lt;-</span> rec_min_prep <span class="sc">|&gt;</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="cn">NULL</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>feat_test <span class="ot">&lt;-</span>rec_min_prep <span class="sc">|&gt;</span> </span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(data_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>And let’s use a mostly out of the box (defaults) 3 layer (1 hidden layer) using Keras engine<br>
<br>
Defaults:</p>
<ul>
<li>hidden units = 5</li>
<li>penalty = 0</li>
<li>dropout = 0</li>
<li>activation = “softmax” for hidden units layer</li>
<li>epochs = 20</li>
<li>seeds = sample.int(10^5, size = 3)</li>
</ul>
<hr>
<p>The default activation for the hidden units when using Keras through tidymodels is <code>softmax</code> not sigmoid as per the basic models discussed in the book and lectures.</p>
<ul>
<li>The activation for the output layer will always be <code>softmax</code> for classification problems when using Keras through tidymodels
<ul>
<li>This is likely a good choice</li>
<li>It provides scores that function like probabilities for each categorical response</li>
</ul></li>
<li>The activation for the output layer will always be ‘linear’ for regression problems.
<ul>
<li>Also a generally good choice</li>
</ul></li>
<li>The hidden units can have a variety of different activation functions
<ul>
<li><code>linear</code>, <code>softmax</code>, <code>relu</code>, and <code>elu</code> through tidymodels</li>
<li>Additional activation functions (and many other “dials”) are available in Keras directly</li>
</ul></li>
</ul>
<hr>
<p>We will adjust <code>seeds</code> from the start<br>
<br>
There are a number of points in the fitting process where random numbers needed by Keras</p>
<ul>
<li>initializing weights for hidden and output layers</li>
<li>selecting units for <code>dropout</code></li>
<li>selecting batches within epochs</li>
</ul>
<p><code>tidymodels</code> lets us provide three seeds to make the first two bullet points more reproducible.<br>
<br>
<br>
There seems to still be some randomness across runs due to batch selection (and possibly other opaque steps)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234567</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>fit_seeds <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">5</span>, <span class="at">size =</span> <span class="dv">3</span>)  <span class="co"># c(87591, 536, 27860)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>We will also set verbose = 0 for now</p>
<ul>
<li>This turns off messages and plots about epoch level performance</li>
<li>At this point, verbose would only report performance in the training data, which isn’t that informative</li>
<li>We will turn it on later when we learn how to get performance in a validation set</li>
<li>Nonetheless, you might still turn it on if you just want feedback on how long it will take for the fit to complete.</li>
</ul>
<hr>
<p>Let’s fit this first model configuration in training set</p>
<ul>
<li><code>verbose = 0</code></li>
<li><code>seeds = fit_seeds</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>fit_1 <span class="ot">&lt;-</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mlp</span>() <span class="sc">|&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"keras"</span>, </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="dv">0</span>, </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">seeds =</span> fit_seeds) <span class="sc">|&gt;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>NOTE: The first model fit with Keras in each new session will generate those warnings/errors about GPU. You can ignore them.</p>
<hr>
<p>Here is this model’s performance in test<br>
<br>
It’s not that great (<span class="red">What would you expect by chance?</span>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy_vec</span>(feat_test<span class="sc">$</span>y, <span class="fu">predict</span>(fit_1, feat_test)<span class="sc">$</span>.pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>313/313 - 1s - 529ms/epoch - 2ms/step</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2063</code></pre>
</div>
</div>
<hr>
<p>Theoretically, the scale of the inputs should not matter<br>
<br>
HOWEVER, gradient descent works better with inputs on the same scale<br>
<br>
We will also want inputs with the same variance if we later apply L2 regularization to our models</p>
<ul>
<li>There is a lot of discussion about how best to scale inputs</li>
<li>Best if the input means are near zero</li>
<li>Best if variances are comparable</li>
</ul>
<hr>
<p>We could:</p>
<ul>
<li>Use <code>step_normalize()</code> [Bad choice of function names by tidymodel folks; standardize vs.&nbsp;normalize]</li>
<li>Use <code>step_range()</code></li>
<li>Book range corrected based on known true range (<code>/ 255</code>)<br>
<br>
We will use <code>step_normalize()</code></li>
</ul>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>rec_scaled_wrong <span class="ot">&lt;-</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> data_trn) <span class="sc">|&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is wrong! Luckily we glimpsed our feature matrix (not displayed here)</p>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: What went wrong and what should we do?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Show Answer</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>Many of the features have zero variance b/c they are black for ALL of the </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>images (e.g., top rows of pixels.  We can not scale a predictor with zero variance </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>b/c when we divide by the SD = 0, we get NaN).  At a minimum, we should remove </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>zero variance predictors in training from training and test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<hr>
<p>For example</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>data_trn<span class="sc">$</span>x1 <span class="sc">|&gt;</span> <span class="fu">sd</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<hr>
<p>Let’s remove zero variance predictors before we scale</p>
<ul>
<li>To be clear, zero variance features are NOT a problem for neural networks (though clearly they won’t help either).</li>
<li>But they WILL definitely cause problems for some scaling transformations.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>rec_scaled <span class="ot">&lt;-</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> data_trn) <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>We now have 717 (+ y) features rather than 28 * 28 = 784 features</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>rec_scaled_prep <span class="ot">&lt;-</span> rec_scaled <span class="sc">|&gt;</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data_trn)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>feat_trn <span class="ot">&lt;-</span> rec_scaled_prep <span class="sc">|&gt;</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="cn">NULL</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 60000   718</code></pre>
</div>
</div>
<hr>
<p>Let’s also make the feature matrix for test. This will exclude features that were zero variance in <strong>train</strong> and scale them by their mean and sd in <strong>train</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>feat_test <span class="ot">&lt;-</span> rec_scaled_prep <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(data_test)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(feat_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10000   718</code></pre>
</div>
</div>
<hr>
<p>Let’s fit and evaluate this new feature set with no other changes to the model configuration</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>fit_2 <span class="ot">&lt;-</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mlp</span>() <span class="sc">|&gt;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"keras"</span>, <span class="at">verbose =</span> <span class="dv">0</span>, <span class="at">seeds =</span> fit_seeds) <span class="sc">|&gt;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>That helped a LOT</li>
<li>Still could be better though (but it always impresses me! ;-)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy_vec</span>(feat_test<span class="sc">$</span>y, <span class="fu">predict</span>(fit_2, feat_test)<span class="sc">$</span>.pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>313/313 - 1s - 513ms/epoch - 2ms/step</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4958</code></pre>
</div>
</div>
<hr>
<p>There are many other recommendations about feature engineering to improve the inputs</p>
<p>These include:</p>
<ul>
<li>Normalize (and here I mean true normalization; e.g., <code>step_BoxCox()</code>, <code>step_YeoJohnson()</code>)</li>
<li>De-correlate (e.g., <code>step_pca()</code> but retain all features?)</li>
</ul>
<p>You can see some discussion of these issues <a href="https://machinelearningmastery.com/how-to-improve-neural-network-stability-and-modeling-performance-with-data-scaling/#:~:text=Scaling%20input%20and%20output%20variables,is%20presented%20to%20a%20network">here</a> and <a href="https://stats.stackexchange.com/questions/7757/data-normalization-and-standardization-in-neural-networks">here</a> to get you started. The <a href="http://yann.lecun.com/exdb/publis/pdf/lecun-98b.pdf">paper</a> linked in the stack overflow response is also a useful starting point.</p>
<hr>
<p>Some <strong>preliminary</strong> modeling EDA on my part suggested these additional considerations didn’t have major impact on the performance of our models with this dataset so we will stick with just scaling the features.</p>
<hr>
<p>It is not surprising that a model configuration with only one hidden layer and 5 units isn’t sufficient for this complex task</p>
<p>Let’s try 30 units (cheating based on the book chapter!! ;-)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>fit_5units <span class="ot">&lt;-</span> <span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="dv">30</span>) <span class="sc">|&gt;</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"keras"</span>, <span class="at">verbose =</span> <span class="dv">0</span>, <span class="at">seeds =</span> fit_seeds) <span class="sc">|&gt;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<ul>
<li>Bingo! Much, much better!</li>
<li>We could see if even more units works better still but I won’t follow that through here for sake of simplicity</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy_vec</span>(feat_test<span class="sc">$</span>y, <span class="fu">predict</span>(fit_5units, feat_test)<span class="sc">$</span>.pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>313/313 - 1s - 554ms/epoch - 2ms/step</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9386</code></pre>
</div>
</div>
<hr>
<p>The Three Blue 1 Brown videos had a brief discussion of the <a href="https://machinelearningmastery.com/rectified-linear-activation-function-for-deep-learning-neural-networks/">relu activation function</a>.</p>
<p>Let’s see how to use other activation functions and if this one helps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>fit_relu <span class="ot">&lt;-</span> <span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="dv">30</span>, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"keras"</span>, <span class="at">verbose =</span> <span class="dv">0</span>, <span class="at">seeds =</span> fit_seeds) <span class="sc">|&gt;</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy_vec</span>(feat_test<span class="sc">$</span>y, <span class="fu">predict</span>(fit_relu, feat_test)<span class="sc">$</span>.pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>313/313 - 0s - 414ms/epoch - 1ms/step</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9647</code></pre>
</div>
</div>
<hr>
</section>
<section id="dealing-with-overfitting" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="dealing-with-overfitting"><span class="header-section-number">10.6</span> Dealing with Overfitting</h2>
<p>As you might imagine, given the number of weights to be fit in even a modest neural network (our 30 hidden unit network has 21,850 parameters to estimate), it is easy to become overfit</p>
<ul>
<li>21,540 for hidden layer (717 * 30 weight + 30 biases)</li>
<li>310 for output layer (30 * 10 weights, + 10 biases)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fit_relu</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parsnip model object

Model: "sequential_3"
________________________________________________________________________________
 Layer (type)                       Output Shape                    Param #     
================================================================================
 dense_6 (Dense)                    (None, 30)                      21540       
 dense_7 (Dense)                    (None, 10)                      310         
================================================================================
Total params: 21850 (85.35 KB)
Trainable params: 21850 (85.35 KB)
Non-trainable params: 0 (0.00 Byte)
________________________________________________________________________________</code></pre>
</div>
</div>
<p>This will be an even bigger problem if you aren’t using “big” data</p>
<hr>
<p>There are a number of different methods available to reduce potential overfitting</p>
<ul>
<li>Simplify the network architecture (fewer units, fewer layers)</li>
<li>L2 regularization</li>
<li>Dropout</li>
<li>Early stopping or monitoring validation error to prevent too many epochs</li>
</ul>
<hr>
<section id="regularization-or-weight-decay" class="level3" data-number="10.6.1">
<h3 data-number="10.6.1" class="anchored" data-anchor-id="regularization-or-weight-decay"><span class="header-section-number">10.6.1</span> Regularization or Weight Decay</h3>
<p>L2 regularization is implemented in essentially the same fashion as you have seen it previously (e.g., glmnet)</p>
<p>The cost function is expanded to include a penalty based on the sum of the squared weights multiplied by <span class="math inline">\(\lambda\)</span>.</p>
<p>In the tidymodels implementation of Keras:</p>
<ul>
<li><p><span class="math inline">\(\lambda\)</span> is called <code>penalty</code> and is set and/or (ideally) tuned via the <code>penalty</code> argument in <code>mlp()</code></p></li>
<li><p>Common values for the L2 <code>penalty</code> to tune a neural network are often on a logarithmic scale between 0 and 0.1, such as 0.1, 0.001, 0.0001, etc.</p></li>
<li><p><code>penalty = 0</code> (the default) means no L2 regularization</p></li>
<li><p>Keras implements other penalties (L1, and a mixture) but not currently through tidymodels</p></li>
<li><p><a href="https://machinelearningmastery.com/how-to-reduce-overfitting-in-deep-learning-with-weight-regularization/">Here</a> is a starting point for more reading on regularization in neural networks</p></li>
</ul>
<hr>
<p>Let’s set <code>penalty = .0001</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>fit_penalty <span class="ot">&lt;-</span> <span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="dv">30</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">penalty =</span> .<span class="dv">0001</span>) <span class="sc">|&gt;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"keras"</span>, <span class="at">verbose =</span> <span class="dv">0</span>, <span class="at">seeds =</span> fit_seeds) <span class="sc">|&gt;</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<ul>
<li>Looks like there is not much benefit to regularization for this network.<br>
</li>
<li>Would likely provide much greater benefit in smaller N contexts or with more complicated model architectures (more hidden units, more hidden unit layers).</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy_vec</span>(feat_test<span class="sc">$</span>y, <span class="fu">predict</span>(fit_penalty, feat_test)<span class="sc">$</span>.pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>313/313 - 0s - 355ms/epoch - 1ms/step</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9661</code></pre>
</div>
</div>
<hr>
</section>
<section id="dropout" class="level3" data-number="10.6.2">
<h3 data-number="10.6.2" class="anchored" data-anchor-id="dropout"><span class="header-section-number">10.6.2</span> Dropout</h3>
<p>Dropout is a second technique to minimize overfitting.<br>
<br>
Here is a clear description of dropout from a blog post on the Machine Learning Mastery:</p>
<ul>
<li><p>Dropout is a technique where randomly selected neurons are ignored during training. They are “dropped-out” randomly. This means that their contribution to the activation of downstream neurons is temporally removed on the forward pass and any weight updates are not applied to the neuron on the backward pass.</p></li>
<li><p>As a neural network learns, neuron weights settle into their context within the network. Weights of neurons are tuned for specific features providing some specialization. Neighboring neurons come to rely on this specialization, which if taken too far can result in a fragile model too specialized to the training data.</p></li>
<li><p>You can imagine that if neurons are randomly dropped out of the network during training, that other neurons will have to step in and handle the representation required to make predictions for the missing neurons. This is believed to result in multiple independent internal representations being learned by the network.</p></li>
<li><p>The effect is that the network becomes less sensitive to the specific weights of neurons. This in turn results in a network that is capable of better generalization and is less likely to overfit the training data.</p></li>
</ul>
<hr>
<p>For further reading, you might start with the 2014 paper by <a href="https://jmlr.org/papers/volume15/srivastava14a/srivastava14a.pdf">Srivastava, et al</a> that proposed the technique.<br>
<br>
In tidymodels, you can set or tune the amount of dropout via the <code>dropout</code> argument in <code>mlp()</code></p>
<ul>
<li>Srivastava, et al suggest starting with values around .5.<br>
</li>
<li>You might consider a range between .1 and .5</li>
<li><code>droppout = 0</code> (the default) means no dropout</li>
<li>In tidymodels implementation of Keras, you can use a non-zero <code>penalty</code> or <code>dropout</code> but not both</li>
</ul>
<hr>
<p>Let’s try <code>dropout = .1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>fit_dropout <span class="ot">&lt;-</span> <span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="dv">30</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">dropout =</span> .<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"keras"</span>, <span class="at">verbose =</span> <span class="dv">0</span>, <span class="at">seeds =</span> fit_seeds) <span class="sc">|&gt;</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<ul>
<li>Looks like there may be a little benefit but not substantial.<br>
</li>
<li>Would likely provide much greater benefit in smaller N contexts or with more complicated model architectures (more hidden units, more hidden unit layers).</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy_vec</span>(feat_test<span class="sc">$</span>y, <span class="fu">predict</span>(fit_dropout, feat_test)<span class="sc">$</span>.pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>313/313 - 1s - 515ms/epoch - 2ms/step</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9653</code></pre>
</div>
</div>
<hr>
</section>
<section id="number-of-epochs-and-early-stopping" class="level3" data-number="10.6.3">
<h3 data-number="10.6.3" class="anchored" data-anchor-id="number-of-epochs-and-early-stopping"><span class="header-section-number">10.6.3</span> Number of Epochs and Early Stopping</h3>
<p>Now that we have a model that is working well, lets return to the issue of number of epochs</p>
<ul>
<li>Too many epochs can lead to overfitting</li>
<li>Too many epochs also just slow things down (not a bit deal if using GPU or overnight but still…..)</li>
<li>Too few epochs can lead to under-fitting (which also produces poor performance)</li>
<li>The default of <code>epochs = 20</code> is a reasonable starting point for a network with one hidden layer but may not work for all situations</li>
</ul>
<hr>
<p>Monitoring training error (loss, accuracy) is not ideal b/c it will tend to always decrease</p>
<ul>
<li>This is what you would get if you set <code>verbose = 1</code></li>
</ul>
<p><br>
<br>
Validation error is what you need to monitor</p>
<ul>
<li>Validation error will increase when the model becomes overfit to training</li>
<li>We can have Keras hold back some portion of the training data for validation
<ul>
<li><code>validation_split = 1/6</code></li>
<li>We pass it in as an optional argument in <code>set_engine()</code></li>
<li>We can use this to monitor validation error rather than training error by epoch.</li>
<li>You can fit an exploratory model with <code>epochs = 50</code> to review the plot</li>
<li>This can allow us to determine an appropriate value for <code>epochs</code></li>
</ul></li>
</ul>
<hr>
<p>Let’s see this in action in the best model configuration without regularization or dropout</p>
<p>NOTE:</p>
<ul>
<li><code>epochs = 50</code></li>
<li><code>verbose = 1</code></li>
<li><code>metrics = c("accuracy")</code></li>
<li><code>validation_split = 1/6</code></li>
<li>You will see message updates and a plot that tracks training and validation loss and accuracy across epochs</li>
<li>This is not rendered into my slides but the plot and messages are pretty clear</li>
<li>You can use this information to choose appropriate values for <code>epoch</code></li>
<li><code>val_accuracy</code> had plateau and <code>val_loss</code> had started to creep up by 10 epochs.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>fit_epochs50 <span class="ot">&lt;-</span> <span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="dv">30</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">epochs =</span> <span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"keras"</span>, <span class="at">verbose =</span> <span class="dv">1</span>, <span class="at">seeds =</span> fit_seeds, </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>), </span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">validation_split =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>) <span class="sc">|&gt;</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>In some instances, it may be that we want to do more than simply look at epoch performance plots during modeling EDA<br>
<br>
We can instead set the number of epochs to be high but use an early stopping callback to end the training early at an optimal time</p>
<hr>
<p>Callbacks allow us to interrupt training.</p>
<ul>
<li>There are many types of callbacks in Keras</li>
<li>We will only discuss <code>callback_early_stopping()</code></li>
<li>We set up callbacks in a list</li>
<li>We pass them in as an optional argument in <code>set_engine()</code> using <code>callbacks =</code></li>
<li>Notice the arguments for <code>callback_early_stopping()</code></li>
<li>We also must provide validation error. Here we set <code>validation_split = 1/6</code></li>
<li>This is a method to <strong>tune or select</strong> best number of epochs.
<ul>
<li>I haven’t yet figured out where the epochs at termination are saved so need to watch the feedback. It was 35 epochs here</li>
<li>As always, we <strong>could</strong> next refit to the full training set after we have determined the optimal number of epochs. We won’t do that here.</li>
</ul></li>
</ul>
<hr>
<p>This fit stopped at 15 epochs</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>callback_list <span class="ot">&lt;-</span> <span class="fu">list</span>(keras<span class="sc">::</span><span class="fu">callback_early_stopping</span>(<span class="at">monitor =</span> <span class="st">"val_loss"</span>, </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">min_delta =</span> <span class="dv">0</span>, </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">patience =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>fit_early <span class="ot">&lt;-</span> <span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="dv">30</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">epochs =</span> <span class="dv">200</span>) <span class="sc">|&gt;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"keras"</span>, <span class="at">verbose =</span> <span class="dv">1</span>,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">seeds =</span> fit_seeds, </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"accuracy"</span> ), </span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">validation_split =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">callbacks =</span> callback_list) <span class="sc">|&gt;</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(y <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy_vec</span>(feat_test<span class="sc">$</span>y, <span class="fu">predict</span>(fit_early, feat_test)<span class="sc">$</span>.pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>313/313 - 0s - 430ms/epoch - 1ms/step</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9642</code></pre>
</div>
</div>
<hr>
<p><strong>Coding sidebar:</strong> You can see many of the optional arguments you can set for Keras in the help <a href="https://keras.rstudio.com/reference/fit.html">here</a>.<br>
<br>
<br>
And you can see more info about <code>callback_early_stopping()</code> <a href="https://keras.rstudio.com/reference/callback_early_stopping.html">here</a></p>
<hr>
</section>
</section>
<section id="using-resampling-to-select-best-model-configuration" class="level2" data-number="10.7">
<h2 data-number="10.7" class="anchored" data-anchor-id="using-resampling-to-select-best-model-configuration"><span class="header-section-number">10.7</span> Using Resampling to Select Best Model Configuration</h2>
<p>Developing a good network artchitecture and considering feature enginnering options involves experimentation</p>
<ul>
<li>This is what Keras is designed to do</li>
<li>tidymodels allows this too</li>
<li>We need to evaluate configurations with a valid method to evaluate performance
<ul>
<li>validation split metric</li>
<li>k-fold metric</li>
<li>bootstrap method</li>
<li>Each can be paired with <code>fit_resamples()</code> or <code>tune_grid()</code></li>
</ul></li>
<li>We need to be systematic
<ul>
<li><code>tune_grid()</code> helps with this too</li>
<li>recipes can be tuned as well (outside the scope of this course)</li>
</ul></li>
</ul>
<hr>
<p>Here is an example where we can select among many model configurations that differ across multiple network characteristics</p>
<ul>
<li>Evaluate with validation split accuracy</li>
<li>Sample size is relatively big so we have 10,000 validation set observations. Should offer a low variance performance estimate</li>
<li>K-fold and bootstrap would still be better but big computation costs (too big for this web book but could be done in real life!)</li>
</ul>
<hr>
<p>Its really just our normal workflow at this point</p>
<ul>
<li>Get splits (validation splits in this example)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102030</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>splits_validation <span class="ot">&lt;-</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  data_trn <span class="sc">|&gt;</span> </span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validation_split</span>(<span class="at">prop =</span> <span class="dv">5</span><span class="sc">/</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<ul>
<li>Set up grid of hyperparameter values</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>grid_keras <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">hidden_units =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">100</span>), </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">penalty =</span> <span class="fu">c</span>(.<span class="dv">00001</span>, .<span class="dv">0001</span>, .<span class="dv">01</span>, .<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<ul>
<li>Use <code>tune_grid()</code> to fit models in training and predict into validation set for each combination of hyperparameter values</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>fits_nn <span class="ot">&lt;-</span> <span class="fu">cache_rds</span>(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> {</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="fu">tune</span>(), <span class="at">penalty =</span> <span class="fu">tune</span>(), <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># setting to verbose = 1 to track progress.  Training error not that useful</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"keras"</span>, <span class="at">verbose =</span> <span class="dv">1</span>, <span class="at">seeds =</span> fit_seeds) <span class="sc">|&gt;</span>  </span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(<span class="at">preprocessor =</span> rec_scaled, </span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">grid =</span> grid_keras,</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">resamples =</span> splits_validation,</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">metrics =</span> <span class="fu">metric_set</span>(accuracy))</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">rerun =</span> rerun_setting,</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">"cache/010/"</span>,</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits_nn"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<ul>
<li>Find model configuration with best performance in the held-out validation set</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(fits_nn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  hidden_units penalty .metric  .estimator  mean     n std_err
         &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
1          100 0.00001 accuracy multiclass 0.973     1      NA
2          100 0.0001  accuracy multiclass 0.970     1      NA
3           50 0.0001  accuracy multiclass 0.967     1      NA
4           50 0.00001 accuracy multiclass 0.966     1      NA
5           30 0.00001 accuracy multiclass 0.962     1      NA
  .config              
  &lt;chr&gt;                
1 Preprocessor1_Model21
2 Preprocessor1_Model22
3 Preprocessor1_Model18
4 Preprocessor1_Model17
5 Preprocessor1_Model13</code></pre>
</div>
</div>
<hr>
</section>
<section id="other-details" class="level2" data-number="10.8">
<h2 data-number="10.8" class="anchored" data-anchor-id="other-details"><span class="header-section-number">10.8</span> Other Details</h2>
<p>We can get a better sense of how tidymodels is interacting with Keras by looking at the function that is called</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mlp</span>(<span class="at">hidden_units =</span> <span class="dv">30</span>, <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">dropout =</span> .<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"keras"</span>, <span class="at">verbose =</span> <span class="dv">0</span>, <span class="at">seeds =</span> fit_seeds) <span class="sc">|&gt;</span> </span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">translate</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Single Layer Neural Network Model Specification (classification)

Main Arguments:
  hidden_units = 30
  dropout = 0.1
  activation = relu

Engine-Specific Arguments:
  verbose = 0
  seeds = fit_seeds

Computational engine: keras 

Model fit template:
parsnip::keras_mlp(x = missing_arg(), y = missing_arg(), hidden_units = 30, 
    dropout = 0.1, activation = "relu", verbose = 0, seeds = fit_seeds)</code></pre>
</div>
</div>
<hr>
<p><code>keras_mlp()</code> is a wrapper around the calls to Keras. Lets see what it does</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>keras_mlp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, y, hidden_units = 5, penalty = 0, dropout = 0, epochs = 20, 
    activation = "softmax", seeds = sample.int(10^5, size = 3), 
    ...) 
{
    if (penalty &gt; 0 &amp; dropout &gt; 0) {
        rlang::abort("Please use either dropoput or weight decay.", 
            call. = FALSE)
    }
    if (!is.matrix(x)) {
        x &lt;- as.matrix(x)
    }
    if (is.character(y)) {
        y &lt;- as.factor(y)
    }
    factor_y &lt;- is.factor(y)
    if (factor_y) {
        y &lt;- class2ind(y)
    }
    else {
        if (isTRUE(ncol(y) &gt; 1)) {
            y &lt;- as.matrix(y)
        }
        else {
            y &lt;- matrix(y, ncol = 1)
        }
    }
    model &lt;- keras::keras_model_sequential()
    if (penalty &gt; 0) {
        model %&gt;% keras::layer_dense(units = hidden_units, activation = activation, 
            input_shape = ncol(x), kernel_regularizer = keras::regularizer_l2(penalty), 
            kernel_initializer = keras::initializer_glorot_uniform(seed = seeds[1]))
    }
    else {
        model %&gt;% keras::layer_dense(units = hidden_units, activation = activation, 
            input_shape = ncol(x), kernel_initializer = keras::initializer_glorot_uniform(seed = seeds[1]))
    }
    if (dropout &gt; 0) {
        model %&gt;% keras::layer_dense(units = hidden_units, activation = activation, 
            input_shape = ncol(x), kernel_initializer = keras::initializer_glorot_uniform(seed = seeds[1])) %&gt;% 
            keras::layer_dropout(rate = dropout, seed = seeds[2])
    }
    if (factor_y) {
        model &lt;- model %&gt;% keras::layer_dense(units = ncol(y), 
            activation = "softmax", kernel_initializer = keras::initializer_glorot_uniform(seed = seeds[3]))
    }
    else {
        model &lt;- model %&gt;% keras::layer_dense(units = ncol(y), 
            activation = "linear", kernel_initializer = keras::initializer_glorot_uniform(seed = seeds[3]))
    }
    arg_values &lt;- parse_keras_args(...)
    compile_call &lt;- expr(keras::compile(object = model))
    if (!any(names(arg_values$compile) == "loss")) {
        if (factor_y) {
            compile_call$loss &lt;- "binary_crossentropy"
        }
        else {
            compile_call$loss &lt;- "mse"
        }
    }
    if (!any(names(arg_values$compile) == "optimizer")) {
        compile_call$optimizer &lt;- "adam"
    }
    compile_call &lt;- rlang::call_modify(compile_call, !!!arg_values$compile)
    model &lt;- eval_tidy(compile_call)
    fit_call &lt;- expr(keras::fit(object = model))
    fit_call$x &lt;- quote(x)
    fit_call$y &lt;- quote(y)
    fit_call$epochs &lt;- epochs
    fit_call &lt;- rlang::call_modify(fit_call, !!!arg_values$fit)
    history &lt;- eval_tidy(fit_call)
    model$y_names &lt;- colnames(y)
    model
}
&lt;bytecode: 0x58b8ad98f570&gt;
&lt;environment: namespace:parsnip&gt;</code></pre>
</div>
</div>
<p>We can see:</p>
<ul>
<li>How the activation functions are setup</li>
<li>The choice of cost function: mse or binary_crossentropy</li>
<li>The optimizer: Adam</li>
<li>How the three seeds are being used</li>
</ul>
<hr>
<p>Finally, you might have noticed that we never set a learning rate anywhere</p>
<p>The <a href="pdfs/kingma_adam_optimizer.pdf">Adam optimizer</a> is used instead of classic stochastic gradient descent. The authors of this optimizer state it is:</p>
<ul>
<li>Straightforward to implement.</li>
<li>Computationally efficient.</li>
<li>Little memory requirements.</li>
<li>Invariant to diagonal rescale of the gradients.</li>
<li>Well suited for problems that are large in terms of data and/or parameters.</li>
<li>Appropriate for non-stationary objectives.</li>
<li>Appropriate for problems with very noisy/or sparse gradients.</li>
<li>Hyper-parameters have intuitive interpretation and typically require little tuning.</li>
</ul>
<hr>
<p>You can start additional reading about Adam <a href="https://machinelearningmastery.com/adam-optimization-algorithm-for-deep-learning/#:~:text=Adam%20is%20a%20replacement%20optimization,sparse%20gradients%20on%20noisy%20problems">here</a></p>
<p>For now, if you want another optimizer or much more control over your network architecture, you may need to work directly in Keras.</p>
<hr>
</section>
<section id="discussion-notes" class="level2" data-number="10.9">
<h2 data-number="10.9" class="anchored" data-anchor-id="discussion-notes"><span class="header-section-number">10.9</span> Discussion Notes</h2>
<section id="announcements" class="level3" data-number="10.9.1">
<h3 data-number="10.9.1" class="anchored" data-anchor-id="announcements"><span class="header-section-number">10.9.1</span> Announcements</h3>
<ul>
<li>Readings for unit 11 ready</li>
<li>Videos/slides will be delayed a bit (complete by early weekend)</li>
</ul>
</section>
<section id="keras-vs-nnet" class="level3" data-number="10.9.2">
<h3 data-number="10.9.2" class="anchored" data-anchor-id="keras-vs-nnet"><span class="header-section-number">10.9.2</span> keras vs nnet</h3>
<ul>
<li>power/flexibility vs.&nbsp;simplicity (but in tidymodels)</li>
<li><code>nnet</code> package</li>
</ul>
</section>
<section id="overview" class="level3" data-number="10.9.3">
<h3 data-number="10.9.3" class="anchored" data-anchor-id="overview"><span class="header-section-number">10.9.3</span> Overview</h3>
<ul>
<li>layers</li>
<li>units</li>
<li>weights, biases</li>
<li>activation functions</li>
<li>gradient descent</li>
<li>back propagation of errors</li>
<li>epochs</li>
<li>stochastic gradient descent (and Adam)</li>
<li>batches</li>
<li>deep learning</li>
</ul>
</section>
<section id="activation-functions" class="level3" data-number="10.9.4">
<h3 data-number="10.9.4" class="anchored" data-anchor-id="activation-functions"><span class="header-section-number">10.9.4</span> Activation functions</h3>
<ul>
<li>perceptron</li>
<li>sigmoid</li>
<li>softmax</li>
<li>relu</li>
</ul>
</section>
<section id="addressing-overfitting" class="level3" data-number="10.9.5">
<h3 data-number="10.9.5" class="anchored" data-anchor-id="addressing-overfitting"><span class="header-section-number">10.9.5</span> Addressing overfitting</h3>
<ul>
<li>L2 regularization</li>
<li>Dropout</li>
</ul>
</section>
<section id="autoencoders" class="level3" data-number="10.9.6">
<h3 data-number="10.9.6" class="anchored" data-anchor-id="autoencoders"><span class="header-section-number">10.9.6</span> Autoencoders</h3>
<ul>
<li>Overview/example</li>
<li>Costs/benefits vs.&nbsp;PCA
<ul>
<li>autoencoders accommodate non-linearity</li>
<li>lots of variants of autoencoders to address different types of data (images, time-series)</li>
<li>autoencoders are very flexible (lots of parameters) - overfitting</li>
<li>autoencoders are computationally costly</li>
<li>autoencoders require expertise to set up and train</li>
<li>PCA <strong>may</strong> be more interpretable (linear combo of features)</li>
</ul></li>
</ul>
</section>
<section id="comparison-of-statistical-algorithms" class="level3" data-number="10.9.7">
<h3 data-number="10.9.7" class="anchored" data-anchor-id="comparison-of-statistical-algorithms"><span class="header-section-number">10.9.7</span> Comparison of statistical algorithms</h3>
<ul>
<li>linear regression (linear model)</li>
<li>logistic regression (from generalized linear model)</li>
<li>glmnet (LASSO, Ridge)</li>
<li>KNN</li>
<li>LDA, QDA</li>
<li>decision trees</li>
<li>bagged decision trees</li>
<li>random forest</li>
<li>MLPs (neural networks)</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./009_random_forest.html" class="pagination-link" aria-label="Advanced Models: Decision Trees, Bagging Trees, and Random Forest">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced Models: Decision Trees, Bagging Trees, and Random Forest</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./011_explanation.html" class="pagination-link" aria-label="Explanatory Approaches">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Explanatory Approaches</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/jjcurtin/book_iaml/edit/main/010_neural_networks.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>