<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>8&nbsp; Advanced Performance Metrics – Introduction to Applied Machine Learning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./l09_random_forest.html" rel="next">
<link href="./l07_midterm.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-231ef2f9d4ce3268f31ef752336c15d2.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="book.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./l08_advanced_performance_metrics.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Advanced Performance Metrics</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Applied Machine Learning</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/jjcurtin/book_iaml" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Syllabus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./course_materials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Materials</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l01_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview of Machine Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l02_exploratory_data_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l03_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introduction to Regression Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l04_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Introduction to Classification Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l05_resampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Resampling Methods for Model Selection and Evaluation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l06_regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Regularization and Penalized Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l07_midterm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Midterm Exam</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l08_advanced_performance_metrics.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Advanced Performance Metrics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l09_random_forest.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced Models: Decision Trees, Bagging Trees, and Random Forest</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l10_neural_networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced Models: Neural Networks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l11_explanation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Explanatory Approaches</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l12_nlp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Natural Language Processing: Text Processing and Feature Engineering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l13_applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Applications for Machine Learning: Synthesis and Concept Generalization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l14_ethics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Ethical Issues in Machine Learning Research and Applications</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l15_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Final Exams - Applications and Concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exec_summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Executive Summary</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./review_midterm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Review Midterm Concepts Exam</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./review_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Review Final Concepts Exam</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Git and Shell Commands</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_dummy_coding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Novel Levels in Held-Out Set(s)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_resampling_with_map.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Map across resamples</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_pca.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Principal Components Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_keras.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installing Keras for Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_word2vec.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Understanding Word Embeddings and word2vec</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_terminology.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Key Terminology and Concepts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_media.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Machine learning/AI in the media</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Test</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives"><span class="header-section-number">8.1</span> Learning Objectives</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">8.2</span> Introduction</a></li>
  <li><a href="#the-confusion-matrix-and-related-performance-metrics" id="toc-the-confusion-matrix-and-related-performance-metrics" class="nav-link" data-scroll-target="#the-confusion-matrix-and-related-performance-metrics"><span class="header-section-number">8.3</span> The Confusion Matrix and Related Performance Metrics</a></li>
  <li><a href="#the-receiver-operating-characteristic-curve" id="toc-the-receiver-operating-characteristic-curve" class="nav-link" data-scroll-target="#the-receiver-operating-characteristic-curve"><span class="header-section-number">8.4</span> The Receiver Operating Characteristic Curve</a></li>
  <li><a href="#using-alternative-performance-metrics-for-model-selection" id="toc-using-alternative-performance-metrics-for-model-selection" class="nav-link" data-scroll-target="#using-alternative-performance-metrics-for-model-selection"><span class="header-section-number">8.5</span> Using Alternative Performance Metrics for Model Selection</a></li>
  <li><a href="#advanced-methods-for-class-imbalances" id="toc-advanced-methods-for-class-imbalances" class="nav-link" data-scroll-target="#advanced-methods-for-class-imbalances"><span class="header-section-number">8.6</span> Advanced Methods for Class Imbalances</a>
  <ul class="collapse">
  <li><a href="#classification-decision-threshold" id="toc-classification-decision-threshold" class="nav-link" data-scroll-target="#classification-decision-threshold"><span class="header-section-number">8.6.1</span> Classification (Decision) Threshold</a></li>
  <li><a href="#performance-metric-considerations" id="toc-performance-metric-considerations" class="nav-link" data-scroll-target="#performance-metric-considerations"><span class="header-section-number">8.6.2</span> Performance Metric Considerations</a></li>
  <li><a href="#sampling-and-resampling-to-address-class-imbalance" id="toc-sampling-and-resampling-to-address-class-imbalance" class="nav-link" data-scroll-target="#sampling-and-resampling-to-address-class-imbalance"><span class="header-section-number">8.6.3</span> Sampling and Resampling to Address Class Imbalance</a></li>
  <li><a href="#up-sampling" id="toc-up-sampling" class="nav-link" data-scroll-target="#up-sampling"><span class="header-section-number">8.6.4</span> Up-sampling</a></li>
  <li><a href="#down-sampling" id="toc-down-sampling" class="nav-link" data-scroll-target="#down-sampling"><span class="header-section-number">8.6.5</span> Down-sampling</a></li>
  <li><a href="#smote" id="toc-smote" class="nav-link" data-scroll-target="#smote"><span class="header-section-number">8.6.6</span> SMOTE</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/jjcurtin/book_iaml/edit/main/l08_advanced_performance_metrics.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Advanced Performance Metrics</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">8.1</span> Learning Objectives</h2>
<ul>
<li>Understand costs and benefits of accuracy</li>
<li>Use of a confusion matrix</li>
<li>Understand costs and benefits of other performance metrics</li>
<li>The ROC curve and area under the curve</li>
<li>Model selection using other performance metrics</li>
<li>How to address class imbalance
<ul>
<li>Selection of performance metric</li>
<li>Selection of classification threshold</li>
<li>Sampling and resampling approaches</li>
</ul></li>
</ul>
<hr>
</section>
<section id="introduction" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="introduction"><span class="header-section-number">8.2</span> Introduction</h2>
<p>In this unit, we will again use the Cleveland heart disease dataset.</p>
<p>However, I have modified this to make the outcome unbalanced such that Yes represents approximately 10% of the observations</p>
<p>Now that we will calculate performance metrics beyond accuracy, the order of the levels of our outcome variable(<code>disease</code>) matters. We will make sure that the positive class (event of interest; in this case yes for <code>disease</code>) is the <strong>first level</strong>.</p>
<hr>
<p>First, lets open and skim the raw data</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>data_all <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_data, <span class="st">"cleveland_unbalanced.csv"</span>), </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">col_names =</span> <span class="cn">FALSE</span>, <span class="at">na =</span> <span class="st">"?"</span>, </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">col_types =</span> <span class="fu">cols</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">age =</span> X1,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">sex =</span> X2,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">cp =</span> X3,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">rest_bp =</span> X4,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">chol =</span> X5,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">fbs =</span> X6,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">rest_ecg =</span> X7,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">exer_max_hr =</span> X8,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">exer_ang =</span> X9,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">exer_st_depress =</span> X10,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">exer_st_slope =</span> X11,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">ca =</span> X12,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">thal =</span> X13,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">disease =</span> X14) </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>data_all <span class="sc">|&gt;</span> <span class="fu">skim_some</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">data_all</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">1281</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">14</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">14</td>
</tr>
<tr class="odd">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p100</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">77.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">sex</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_bp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">200.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chol</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">126</td>
<td style="text-align: right;">564.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">fbs</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rest_ecg</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_max_hr</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">202.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_ang</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_st_depress</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6.2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_slope</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">ca</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">thal</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">7.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">disease</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
<p>Code categorical variables as factors with meaningful text labels (and no spaces)</p>
<ul>
<li>NOTE the use of <code>disease = fct_relevel (disease, "yes")</code> to set yes as positive class (first level) for disease</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data_all <span class="ot">&lt;-</span> data_all <span class="sc">|&gt;</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">disease =</span> <span class="fu">factor</span>(disease, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">4</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"no"</span>, <span class="st">"yes"</span>, <span class="st">"yes"</span>, <span class="st">"yes"</span>, <span class="st">"yes"</span>)),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">disease =</span> <span class="fu">fct_relevel</span> (disease, <span class="st">"yes"</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">sex =</span> <span class="fu">factor</span>(sex,  <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"male"</span>)),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">fbs =</span> <span class="fu">factor</span>(fbs, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"no"</span>, <span class="st">"yes"</span>)),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">exer_ang =</span> <span class="fu">factor</span>(exer_ang, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"no"</span>, <span class="st">"yes"</span>)),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">exer_st_slope =</span> <span class="fu">factor</span>(exer_st_slope, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                                <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"upslope"</span>, <span class="st">"flat"</span>, <span class="st">"downslope"</span>)),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">cp =</span> <span class="fu">factor</span>(cp, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"typ_ang"</span>, <span class="st">"atyp_ang"</span>, <span class="st">"non_anginal"</span>, <span class="st">"non_anginal"</span>)),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">rest_ecg =</span> <span class="fu">factor</span>(rest_ecg, <span class="at">levels =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>, </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"normal"</span>, <span class="st">"wave_abn"</span>, <span class="st">"ventric_hypertrophy"</span>)),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">thal =</span> <span class="fu">factor</span>(thal, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">7</span>), </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"normal"</span>, <span class="st">"fixeddefect"</span>, <span class="st">"reversabledefect"</span>)))</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>data_all <span class="sc">|&gt;</span> <span class="fu">skim_some</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">data_all</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">1281</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">14</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 11%">
<col style="width: 16%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">sex</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">mal: 752, fem: 529</td>
</tr>
<tr class="even">
<td style="text-align: left;">cp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">non: 872, aty: 296, typ: 113</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fbs</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">no: 1104, yes: 177</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_ecg</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">nor: 721, ven: 550, wav: 10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_ang</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">no: 1044, yes: 237</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_st_slope</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">ups: 778, fla: 434, dow: 69</td>
</tr>
<tr class="odd">
<td style="text-align: left;">thal</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">nor: 940, rev: 285, fix: 48</td>
</tr>
<tr class="even">
<td style="text-align: left;">disease</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">no: 1142, yes: 139</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p100</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">77.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_bp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">200.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chol</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">126</td>
<td style="text-align: right;">564.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_max_hr</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">202.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_depress</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">ca</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
<p>Disease is now unbalanced</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data_all <span class="sc">|&gt;</span> <span class="fu">tab</span>(disease)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  disease     n  prop
  &lt;fct&gt;   &lt;int&gt; &lt;dbl&gt;
1 yes       139 0.109
2 no       1142 0.891</code></pre>
</div>
</div>
<hr>
<p>For this example, we will evaluate our final model using a held out test set</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20140102</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>splits_test <span class="ot">&lt;-</span> data_all <span class="sc">|&gt;</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_split</span>(<span class="at">prop =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">strata =</span> <span class="st">"disease"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>data_trn <span class="ot">&lt;-</span> splits_test <span class="sc">|&gt;</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analysis</span>()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>data_test <span class="ot">&lt;-</span> splits_test <span class="sc">|&gt;</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assessment</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>We will be fitting a penalized logistic regression again (using glmnet)</p>
<p>We will do only basic feature engineering for this algorithm and to handle missing data</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> data_trn) <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span>   </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>We tune/select best hyperparameter values via bootstrap resampling with the training data</p>
<ul>
<li>get bootstrap splits</li>
<li>make grid of hyperparameter values</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>splits_boot <span class="ot">&lt;-</span> data_trn <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bootstraps</span>(<span class="at">times =</span> <span class="dv">100</span>, <span class="at">strata =</span> <span class="st">"disease"</span>)  </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>grid_glmnet <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">penalty =</span> <span class="fu">exp</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">8</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">200</span>)),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">mixture =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fits_glmnet <span class="ot">&lt;-</span> <span class="fu">cache_rds</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mixture =</span> <span class="fu">tune</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tune_grid</span>(<span class="at">preprocessor =</span> rec, </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">resamples =</span> splits_boot, <span class="at">grid =</span> grid_glmnet, </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">metrics =</span> <span class="fu">metric_set</span>(accuracy))</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">"cache/008/"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits_glmnet"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">rerun =</span> rerun_setting)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Review hyperparameter plot and best values for hyperparameters</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hyperparameters</span>(fits_glmnet, <span class="at">hp1 =</span> <span class="st">"penalty"</span>, <span class="at">hp2 =</span> <span class="st">"mixture"</span>, </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">metric =</span> <span class="st">"accuracy"</span>, <span class="at">log_hp1 =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(fits_glmnet, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">metric =</span> <span class="st">"accuracy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
   penalty mixture .metric  .estimator  mean     n std_err
     &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
1 0.000335     0.8 accuracy binary     0.933   100 0.00104
  .config                
  &lt;chr&gt;                  
1 Preprocessor1_Model0801</code></pre>
</div>
</div>
<hr>
<p>Let’s fit this best model configuration to all of our training data and evaluate it in test</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>rec_prep <span class="ot">&lt;-</span> rec <span class="sc">|&gt;</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data_trn)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>feat_trn <span class="ot">&lt;-</span> rec_prep <span class="sc">|&gt;</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(data_trn)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>fit_glmnet <span class="ot">&lt;-</span>   </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">select_best</span>(fits_glmnet, <span class="at">metric =</span> <span class="st">"accuracy"</span>)<span class="sc">$</span>penalty, </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">mixture =</span> <span class="fu">select_best</span>(fits_glmnet, <span class="at">metric =</span> <span class="st">"accuracy"</span>)<span class="sc">$</span>mixture) <span class="sc">|&gt;</span> </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>And evaluate it by predicting into test</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>feat_test <span class="ot">&lt;-</span> rec_prep <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(data_test)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>(model_accuracy <span class="ot">&lt;-</span> <span class="fu">accuracy_vec</span>(feat_test<span class="sc">$</span>disease, <span class="fu">predict</span>(fit_glmnet, feat_test)<span class="sc">$</span>.pred_class))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9299065</code></pre>
</div>
</div>
<hr>
<p>Accuracy is an attractive measure because it is:</p>
<ul>
<li>Intuitive and widely understood</li>
<li>Naturally extends to multi-class scenarios</li>
<li>These are not trivial advantages in research or application</li>
</ul>
<p>However, accuracy has at least three problems in some situations</p>
<ul>
<li><p>If the outcome is unbalanced, it can be misleading</p>
<ul>
<li>High performance from simply predicting the majority (vs.&nbsp;minority) class for all observations</li>
<li>Need to anchor evaluation of accuracy to baseline performance based on the majority case percentage</li>
</ul></li>
<li><p>If the outcome is unbalanced, selecting among model configurations with accuracy can be biased toward configurations that predict the majority class because that will yield high accuracy by itself even without any signal from the predictors</p></li>
<li><p>Regardless of outcome distribution, it considers false positives (FP) and false negatives (FN) equivalent in their costs</p>
<ul>
<li>This is often not the case</li>
</ul></li>
</ul>
<hr>
<p>Outcome distributions :</p>
<ul>
<li>May start to be considered unbalanced at ratios of 1:5 (20% of cases in the infrequent class)</li>
<li>In many real life applications (e.g., fraud detection), imbalance ratios ranging from 1:1000 up to 1:5000 are not atypical</li>
</ul>
<p>When working with unbalanced datasets:</p>
<ul>
<li>The class or classes with many observations are called the major or <strong>majority class(es)</strong></li>
<li>The class with few observations (and there is typically just one) is called the minor or <strong>minority class</strong>.</li>
</ul>
<p>In our example, the majority class is negative (no) for heart disease and the minority class is positive (yes) for heart disease</p>
<hr>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: In our example, our model’s accuracy in test seemed high but was it really performing as well as this seems?
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="fragment uwred">
<p>Although this test accuracy seems high, this is somewhat misleading. A model that simply labeled everyone as negative for heart disease would achieve almost as high accuracy in our test data</p>
</div>
<hr>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>(model_accuracy <span class="ot">&lt;-</span> <span class="fu">accuracy_vec</span>(feat_test<span class="sc">$</span>disease, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">predict</span>(fit_glmnet, feat_test)<span class="sc">$</span>.pred_class))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9299065</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>feat_test <span class="sc">|&gt;</span> <span class="fu">tab</span>(disease)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  disease     n  prop
  &lt;fct&gt;   &lt;int&gt; &lt;dbl&gt;
1 yes        47 0.110
2 no        381 0.890</code></pre>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: Perhaps more importantly, are the costs of false positives (screening someone as positive when they do not have heart disease) and false negatives (screening someone as negative when they do have heart disease) comparable for a preliminary screening method?
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="fragment uwred">
<p>Probably not. A false positive might mean that we do more testing that is unnecessary and later find out they do not have heart disease. This comes with some monetary cost and also likely some distress for the patient. However, a false negative means we send the patient home thinking they are healthy and may suffer a heart attack or other bad outcome. That seems worse if this is only a preliminary screen.</p>
</div>
<hr>
</section>
<section id="the-confusion-matrix-and-related-performance-metrics" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="the-confusion-matrix-and-related-performance-metrics"><span class="header-section-number">8.3</span> The Confusion Matrix and Related Performance Metrics</h2>
<p>At a minimum, it seems important to consider these issues explicitly but accuracy is not sufficiently informative.</p>
<p>The first step to this more careful assessment is to construct a confusion matrix</p>
<hr>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;"><strong>Ground Truth</strong></th>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Prediction</strong></td>
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">Negative</td>
</tr>
<tr class="even">
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">TP</td>
<td style="text-align: left;">FP</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Negative</td>
<td style="text-align: left;">FN</td>
<td style="text-align: left;">TN</td>
</tr>
</tbody>
</table>
<p>Definitions:</p>
<ul>
<li>TP: True positive</li>
<li>TN: True negative</li>
<li>FP: False positive (Type 1 error/false alarm)</li>
<li>FN: False negative (Type 2 error/miss)</li>
</ul>
<p>Perfect classifier has all the observations on the diagonal from top left to bottom right</p>
<p>The two types of errors (on the other diagonal) may have different costs</p>
<p>We can now begin to consider these costs</p>
<hr>
<p>Lets look at the confusion matrix associated with our model’s performance in test</p>
<ul>
<li>We will use <code>conf_mat()</code> to calculate the confusion matrix</li>
<li>There does NOT (yet?) seem to be a vector version (i.e., <code>conf_mat_vec()</code>)</li>
<li>Therefore, we have to build a tibble of <code>truth</code> and <code>estimate</code> to pass into <code>conf_mat()</code></li>
<li>It is best to assign the result to an object (e.g., <code>cm</code>) because we will use it for a few different tasks</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>cm <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">estimate =</span> <span class="fu">predict</span>(fit_glmnet, feat_test)<span class="sc">$</span>.pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(truth, estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Let’s display the matrix</p>
<ul>
<li><p>The columns are sorted based on the true value for the observation (i.e., ground truth)</p>
<ul>
<li>In this case, that is the patients’ true disease status</li>
<li>We can see it is unbalanced with most of the cases in the “no” column</li>
</ul></li>
<li><p>The rows are sorted by our model’s predictions</p></li>
<li><p>As we noted above, correct predictions fall on the top/left- bottom/right diagonal</p></li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>cm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction yes  no
       yes  30  13
       no   17 368</code></pre>
</div>
</div>
<hr>
<p>Tidy model’s makes it easy to visualize this matrix in one of two types of plots</p>
<ul>
<li>mosaic (the default)</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-16-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>heatmap</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cm, <span class="at">type =</span> <span class="st">"heatmap"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-17-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Regardless of the plot, you can now begin to see the issues with our model</p>
<ul>
<li>It seems accurate for patients that do NOT have heart disease
<ul>
<li>368/381 correct</li>
</ul></li>
<li>It is not very accurate for patients that DO have heart disease
<ul>
<li>30/47 correct</li>
</ul></li>
<li>This differential performance was masked by our global accuracy measure because overall accuracy was weighted heavily toward accuracy for patients without heart disease given their much higher numbers</li>
</ul>
<hr>
<p>We can use this confusion matrix as the starting point for MANY other common metrics and methods for evaluating the performance of a classification model. In many instances, the metrics come in pairs that are relevant for FP and FN errors</p>
<ul>
<li>Sensitivity &amp; Specificity</li>
<li>Positive and Negative Predictive Value (PPV, NPV)</li>
<li>Precision and Recall</li>
</ul>
<hr>
<p>There are also some single metric approaches (like accuracy) that may be preferred when the outcome is unbalanced</p>
<ul>
<li>Balanced accuracy</li>
<li>F1 (and other F-scores)</li>
<li>Kappa</li>
</ul>
<hr>
<p>There are also graphical approaches are based on either sensitivity/specificity or precision/recall. These are:</p>
<ul>
<li>The Receiver Operating Characteristic (ROC) curve</li>
<li>The Precision/Recall Curve (not covered further in this unit)</li>
<li>Each of these curves also yields a single metric that represents the area under the curve</li>
</ul>
<hr>
<p>The best metric/method is a function both of your intended use and the class distributions</p>
<ul>
<li><p>As noted, <strong>accuracy</strong> is widely understood but can be misleading when class distributions are highly unbalanced</p></li>
<li><p><strong>Sensitivity/Specificity</strong> are common in literatures that consider diagnosis (clinical psychology/psychiatry, medicine)</p></li>
<li><p><strong>Positive/Negative predictive value</strong> are key to consider with sensitivity/specificity when classes are unbalanced</p></li>
<li><p><strong>ROC curve and its auROC metric</strong> provide nice summary visualization and metric when considering classification thresholds other than 50% (also common when classes are unbalanced or types of errors matter)</p></li>
</ul>
<hr>
<p>Here are definitions of many of the most common metrics linked to the confusion matrix</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;"><strong>Ground Truth</strong></th>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Prediction</strong></td>
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">Negative</td>
</tr>
<tr class="even">
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">TP</td>
<td style="text-align: left;">FP</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Negative</td>
<td style="text-align: left;">FN</td>
<td style="text-align: left;">TN</td>
</tr>
</tbody>
</table>
<p><span class="math inline">\(Accuracy = \frac{TN + TP}{TN + TP + FN + FP}\)</span></p>
<p><span class="math inline">\(Sensitivity\:(Recall) = \frac{TP}{TP + FN}\)</span></p>
<p><span class="math inline">\(Specificity = \frac{TN}{TN + FP}\)</span></p>
<p><span class="math inline">\(Positive\:Predictive\:Value\:(Precision) = \frac{TP}{TP + FP}\)</span></p>
<p><span class="math inline">\(Negative\:Predictive\:Value = \frac{TN}{TN + FN}\)</span></p>
<p><span class="math inline">\(Balanced\:accuracy = \frac{Sensitivity + Specificity}{2}\)</span></p>
<p><span class="math inline">\(F_\beta\)</span> score:</p>
<ul>
<li><p><span class="math inline">\(F1 = 2 * \frac{Precision * Recall}{Precision + Recall}\)</span> (most common; harmonic mean of precision and recall)</p></li>
<li><p><span class="math inline">\(F_\beta = (1 + \beta^2) * \frac{Precision * Recall}{(\beta^2*Precision) + Recall}\)</span></p></li>
<li><p><span class="math inline">\(F_\beta\)</span> was derived so that it measures the effectiveness of a classifier for someone who assigns <span class="math inline">\(\beta\)</span> times as much importance to recall as precision</p></li>
</ul>
<hr>
<p>It is easy to get any of these performance metrics using <code>summary()</code> on the confusion matrix</p>
<p>Many of the statistics generated are based on an understanding of which level is the positive level.</p>
<ul>
<li>Tidymodels (yardstick to be precise) will default to consider the first level the positive level.<br>
</li>
<li>If this is not true, some statistics (e.g., sensitivity, specificity) will be incorrect (i.e., swapped).</li>
<li>You can override this default by setting the following parameter inside any function that is affected by the order of the classes” <code>event_level = "second"</code></li>
</ul>
<hr>
<p>Here is summary in action!</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>cm <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 3
   .metric              .estimator .estimate
   &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;
 1 accuracy             binary         0.930
 2 kap                  binary         0.628
 3 sens                 binary         0.638
 4 spec                 binary         0.966
 5 ppv                  binary         0.698
 6 npv                  binary         0.956
 7 mcc                  binary         0.628
 8 j_index              binary         0.604
 9 bal_accuracy         binary         0.802
10 detection_prevalence binary         0.100
11 precision            binary         0.698
12 recall               binary         0.638
13 f_meas               binary         0.667</code></pre>
</div>
</div>
<hr>
<p>Let’s consider some of what these metrics are telling us about our classifier by looking at the metrics and a confusion matrix plot</p>
<p>Let’s start with <strong>sensitivity</strong> and <strong>specificity</strong> and their arithmetic mean (<strong>balanced accuracy</strong>)</p>
<ul>
<li>These are column specific accuracies</li>
<li>Focus is on truth (columns)</li>
<li>Focuses a priori on two types of patients that may walk into the clinic to use our classifier</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>cm <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"sens"</span> <span class="sc">|</span> .metric <span class="sc">==</span> <span class="st">"spec"</span> <span class="sc">|</span> .metric <span class="sc">==</span> <span class="st">"bal_accuracy"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  .metric      .estimate
  &lt;chr&gt;            &lt;dbl&gt;
1 sens             0.638
2 spec             0.966
3 bal_accuracy     0.802</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cm, <span class="at">type =</span> <span class="st">"heatmap"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-20-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: Can you link the numbers in the confusion matrix on the previous slide to Sensitivity and Specificity metrics
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="fragment uwred">
<p>Sensivity is “accuracy” for the positive cases (in this instance, those with disease = yes).<br>
Sensitivity = 30 / (17 + 30)</p>
<p>Specificity is “accuracy” for the negative cases (disease = no).<br>
Specificity = 368 / (368 + 13)</p>
</div>
<hr>
<p>Now let’s consider <strong>positive predictive value</strong> and <strong>negative predictive value</strong></p>
<ul>
<li>These are row specific accuracies</li>
<li>Focus is on model predictions (rows)</li>
<li>Focuses on the utility of the information/screening result provided from our classifier</li>
<li>Not typically reported alone but instead in combo with sensitivity/specificity and prevalence (see next pages)</li>
<li>Mosaic plot is better visualization for sensitivity/specificity (though I also like the numbers). Not that useful for PPV/NPV</li>
<li>Use heatmap?</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cm, <span class="at">type =</span> <span class="st">"heatmap"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-21-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cm, <span class="at">type =</span> <span class="st">"heatmap"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-22-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>cm <span class="sc">|&gt;</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"ppv"</span> <span class="sc">|</span> .metric <span class="sc">==</span> <span class="st">"npv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  .metric .estimate
  &lt;chr&gt;       &lt;dbl&gt;
1 ppv         0.698
2 npv         0.956</code></pre>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: Can you link the numbers in the confusion matrix on the previous slide to PPV and NPV metrics
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="fragment uwred">
<p>PPV is “accuracy” for the positive predictions (in this instance, when the model predicts yes. PPV = 30 / (30 + 13)</p>
<p>NPV is “accuracy” for the negative predictions (disease = no).<br>
NPV = 368 / (368 + 17)</p>
</div>
<hr>
<ul>
<li><p>PPV and NPV are influenced by both sensitivity and specificity BUT ALSO prevalence.</p></li>
<li><p>This becomes important in unbalanced settings where prevalence of classes is not equal</p>
<ul>
<li>Your classifier’s PPV will be lower, even with good sensitivity and specificity if the prevalence of the positive class is low<br>
</li>
<li>Conversely, your classifier’s NPV will be lower, even with good sensitivity and specificity, if the prevalence of the negative class is low.</li>
</ul></li>
<li><p>Prevalence also can vary by testing setting</p></li>
</ul>
<hr>
<p>Tests for many genetic disorders have very good sensitivity and specificity but their PPV (and NPV) vary widely by setting/patients tested</p>
<ul>
<li>Test for multiple endocrine neoplasia type 2 (MEN2) based on mutations in RET
<ul>
<li>Sensitivity = 98%</li>
<li>Specificity = 99.9%</li>
</ul></li>
</ul>
<p>MENS2 has prevalence of 1/30,000 in general population. If using the test in the general population with 3 million people:</p>
<ul>
<li>100 will have the disease</li>
<li>2,999,900 will not have the disease</li>
<li>Column accuracies (sensitivity and specificity) are high</li>
<li>PPV will be very BAD; 98/(3000 + 98) = 3.2%</li>
<li>Though NPV will be very near perfect! 2996900 / (2996900 + 2)</li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;"><strong>Ground Truth</strong></th>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Prediction</strong></td>
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">Negative</td>
</tr>
<tr class="even">
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">98</td>
<td style="text-align: left;">3000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Negative</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">2996900</td>
</tr>
</tbody>
</table>
<hr>
<p>However, MENS2 prevalence is high (1/5) among patients who present in a clinic with medullary thyroid carcinoma. If we only used the test among 3 million of these patients</p>
<ul>
<li>600,000 will have the disease</li>
<li>2,400,000 will NOT have the disease (still unbalanced by but much less)</li>
<li>Column accuracies (sensitivity and specificity) remain the same (98% and 99.9%)
<ul>
<li>These are properties of the test/classifier</li>
</ul></li>
<li>PPV is now much better; 588,000 / (2400 + 588,000) = 99.6%</li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;"><strong>Ground Truth</strong></th>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Prediction</strong></td>
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">Negative</td>
</tr>
<tr class="even">
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">588000</td>
<td style="text-align: left;">2400</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Negative</td>
<td style="text-align: left;">12000</td>
<td style="text-align: left;">2397600</td>
</tr>
</tbody>
</table>
<hr>
<p>Now think about “accuracy” of any specific COVID test</p>
<ul>
<li>It dismayed me to see talk of accuracy
<ul>
<li>The cost of the two types of errors is different!</li>
</ul></li>
<li>Occasionally, there was talk of sensitivity and specificity</li>
<li>There was rarely/never discussion of PPV and NPV, which is what matters most when you are given your test result</li>
</ul>
<hr>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: How would the PPV and NPV change when we moved from testing only people with symptoms who presented at the hospital to testing everyone (e.g., all college students)?
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="fragment uwred">
<p>Relatively speaking, when testing someone with obvious COVID symptoms PPV would be high but NPV could be low. Conversely, for our students PPV is likely low but NPV is likely high</p>
</div>
<hr>
<p>In some instances, it may be more useful to focus on <strong>precision</strong> and <strong>recall</strong> rather than sensitivity and specificity. The <strong>F1 measure</strong> is the harmonic mean of precision and recall</p>
<ul>
<li>This is a row and column accuracy</li>
<li>Recall (sensitivity) focuses on how many true positive cases will we correctly identify</li>
<li>Precision (PPV) focuses on how accurate the prediction of “positive” will be (prevalence dependent)</li>
<li>This keeps the focus on positive cases</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cm, <span class="at">type =</span> <span class="st">"heatmap"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-24-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cm, <span class="at">type =</span> <span class="st">"heatmap"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-25-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>cm <span class="sc">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"precision"</span> <span class="sc">|</span> .metric <span class="sc">==</span> <span class="st">"recall"</span> <span class="sc">|</span> .metric <span class="sc">==</span> <span class="st">"f_meas"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  .metric   .estimate
  &lt;chr&gt;         &lt;dbl&gt;
1 precision     0.698
2 recall        0.638
3 f_meas        0.667</code></pre>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: Can you link the numbers in the confusion matrix on the previous slide to Recall (Sensitivity) and Precision (PPV) metrics
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="fragment uwred">
<p>Recall/sensitivity is “accuracy” for the positive cases (in this instance, patients with heart disease). 30 / (30 + 17)</p>
<p>Precision/PPV is “accuracy” for the positive predictions (when model predicts yes).<br>
30 / (30 + 13)</p>
</div>
<hr>
<p><span class="math inline">\(F1\)</span> is the harmonic mean of Recall and Precision</p>
<ul>
<li>Harmonic means are used with rates (see <a href="https://en.wikipedia.org/wiki/Mean">more detail</a> about the Pythagorean means, if interested)</li>
<li><span class="math inline">\(F1\)</span> is an unweighted harmonic mean
<ul>
<li><span class="math inline">\(F1 = 2 * \frac{Precision * Recall}{Precision + Recall}\)</span></li>
<li>or using the more general formula for harmonic means: <span class="math inline">\(F1 = \frac{2}{\frac{1}{Precision} + \frac{1}{Recall}}\)</span></li>
</ul></li>
<li><span class="math inline">\(F_\beta\)</span> is a weighted version where <span class="math inline">\(\beta\)</span> is the relative weighting of recall to precision
<ul>
<li>Two commonly used values for <span class="math inline">\(\beta\)</span> are 2, which weighs recall twice as much than precision, and 0.5, which weighs precision twice as much as recall</li>
<li><span class="math inline">\(F_\beta = (1 + \beta^2) * \frac{Precision * Recall}{(\beta^2*Precision) + Recall}\)</span></li>
</ul></li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>cm <span class="sc">|&gt;</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"precision"</span> <span class="sc">|</span> .metric <span class="sc">==</span> <span class="st">"recall"</span> <span class="sc">|</span> .metric <span class="sc">==</span> <span class="st">"f_meas"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  .metric   .estimate
  &lt;chr&gt;         &lt;dbl&gt;
1 precision     0.698
2 recall        0.638
3 f_meas        0.667</code></pre>
</div>
</div>
<hr>
<p><strong>Cohen’s Kappa</strong> is a bit more complicated to calculate and understand</p>
<ul>
<li><p>There is a great <a href="https://stats.stackexchange.com/questions/82162/cohens-kappa-in-plain-english">explanation of kappa</a> on stack overflow</p></li>
<li><p>Wikipedia also has a very detailed <a href="https://en.wikipedia.org/wiki/Cohen's_kappa">definition and explanation</a> as well (though not in the context of machine learning)</p></li>
<li><p>Compares observed accuracy to expected accuracy (random chance)</p></li>
</ul>
<p><span class="math inline">\(Kappa = \frac{observed\:accuracy - expected\:accuracy}{1 - expected\:accuracy}\)</span></p>
<ul>
<li><p>When outcome is unbalanced, some agreement/accuracy (relationship between model predictions and reference/ground truth) is expected</p></li>
<li><p>Kappa adjusts for this</p></li>
</ul>
<p>Kappa is essentially the proportional increase in accuracy above the accuracy expected by the base rates of the reference and classifier</p>
<hr>
<p>To calculate the expected accuracy, we need to consider the probabilities of reference and classifier prediction both being positive (and both being negative) by chance given the base rates of these classes for the reference and classifier.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;"><strong>Ground Truth</strong></th>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Prediction</strong></td>
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">Negative</td>
</tr>
<tr class="even">
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">TP</td>
<td style="text-align: left;">FP</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Negative</td>
<td style="text-align: left;">FN</td>
<td style="text-align: left;">TN</td>
</tr>
</tbody>
</table>
<p><span class="math inline">\(P_{positive} = \frac{FN + TP}{TN + FN + FP + TP} * \frac{FP + TP}{TN + FN + FP + TP}\)</span></p>
<p><span class="math inline">\(P_{negative} = \frac{TN + FP}{TN + FN + FP + TP} * \frac{TN + FN}{TN + FN + FP + TP}\)</span></p>
<p><span class="math inline">\(P_{expected} = P_{positive} + P_{negative}\)</span></p>
<hr>
<p>In our example</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>cm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction yes  no
       yes  30  13
       no   17 368</code></pre>
</div>
</div>
<p><span class="math inline">\(P_{positive} = \frac{17 + 30}{428} * \frac{13 + 30}{428} = 0.01103262\)</span></p>
<p><span class="math inline">\(P_{negative} = \frac{368 + 13}{428} * \frac{368 + 17}{428} = 0.8007522\)</span></p>
<p><span class="math inline">\(P_{expected} = 0.01103262 + 0.8007522 = 0.8117848\)</span></p>
<p><span class="math inline">\(Actual Accuracy = 0.9299065\)</span></p>
<p><span class="math inline">\(Kappa = \frac{observed\:accuracy - expected\:accuracy}{1 - expected\:accuracy}\)</span></p>
<p><span class="math inline">\(Kappa = \frac{0.9299065 - 0.8117848}{1 - 0.8117848} = 0.627588\)</span></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cm) <span class="sc">|&gt;</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"kap"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6275886</code></pre>
</div>
</div>
<hr>
<p>Kappa Rules of Thumb w/ a big grain of salt…….</p>
<ul>
<li>Kappa &lt; 0: No agreement</li>
<li>Kappa between 0.00 and 0.20: Slight agreement</li>
<li>Kappa between 0.21 and 0.40: Fair agreement</li>
<li>Kappa between 0.41 and 0.60: Moderate agreement</li>
<li>Kappa between 0.61 and 0.80: Substantial agreement</li>
<li>Kappa between 0.81 and 1.00: Almost perfect agreement.</li>
</ul>
<p>See <span class="citation" data-cites="Landis1977">Landis and Koch (<a href="#ref-Landis1977" role="doc-biblioref">1977</a>)</span> (<a href="pdfs/landis_1977_kappa.pdf">PDF</a>)for more details</p>
<hr>
</section>
<section id="the-receiver-operating-characteristic-curve" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="the-receiver-operating-characteristic-curve"><span class="header-section-number">8.4</span> The Receiver Operating Characteristic Curve</h2>
<p>Let’s return now to consider sensitivity and specificity again</p>
<p>Remember that our classifier is estimating the probability of an observation being in the positive class.</p>
<p>We dichotomize this probability when we formally make a class prediction</p>
<ul>
<li>If the probability &gt; 50%, we classify the observation as positive</li>
<li>If the probability &lt;= 50%, we classify the observation as negative</li>
</ul>
<hr>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: How can we improve sensitivity?
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="fragment uwred">
<p>We can use a more liberal/lower classification threshold for saying someone has heart disease.</p>
<p>For example, rather than requiring a 50% probability to classify as yes for heart disease, we could lower to 20% for the classification threshold</p>
</div>
<hr>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: What will the consequences of this change be?
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="fragment uwred">
<p>First, the Bayes classifier threshold of 50% produces the highest overall accuracy so accuracy will generally (though not always) drop when you shift from 50%.</p>
<p>If we think about this change as it applies to the columns of our confusion matrix, we will now catch more of the yes (fewer false negatives/misses), so sensitivity will go up. This was the goal of the lower threshold. However, we will also end up with more false positives so specificity will drop. If you consider the rows of the confusion matrix, we will have more false positives so the PPV will drop.</p>
<p>However, we will have fewer false negatives so the NPV will increase. Whether these trade-offs are worth it are a function of the cost of different types of errors and how much you gain and lose with regard to each type of performance metric (ROC can inform this; more in a moment)</p>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cm, <span class="at">type =</span> <span class="st">"heatmap"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-30-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Previously, we simply used <code>predict(fit_glmnet, feat_test)$.pred_class</code>.</p>
<p><code>$.pred_class</code> dichotomized at 50% by default</p>
<ul>
<li>This is the classification threshold to use with predicted probabilities that will produce the best overall accuracy (e.g., Bayes classifier)</li>
<li>However, we can use a different threshold to increase sensitivity or specificity</li>
<li>This comes at a cost to the other characteristic (its a trade-off)
<ul>
<li>Lower threshold increases sensitivity but decreases specificity</li>
<li>Higher threshold increases specificity but decreases sensitivity</li>
</ul></li>
</ul>
<hr>
<p>It is relatively easy to make a new confusion matrix and get new performance metrics with a different classification threshold</p>
<ul>
<li>Make a tibble with truth and predicted probabilities</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">prob =</span> <span class="fu">predict</span>(fit_glmnet, feat_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 428 × 2
   truth    prob
   &lt;fct&gt;   &lt;dbl&gt;
 1 no    0.0160 
 2 no    0.117  
 3 no    0.0200 
 4 no    0.00231
 5 no    0.00984
 6 no    0.00143
 7 no    0.00507
 8 no    0.0421 
 9 no    0.00773
10 no    0.103  
# ℹ 418 more rows</code></pre>
</div>
</div>
<hr>
<ul>
<li>Use this to get class estimates at any threshold we want</li>
<li>Here we threshold at 20%</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> preds <span class="sc">|&gt;</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">estimate_20 =</span> <span class="fu">if_else</span>(prob <span class="sc">&lt;=</span> .<span class="dv">20</span>, <span class="st">"no"</span>, <span class="st">"yes"</span>),</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate_20 =</span> <span class="fu">factor</span>(estimate_20, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"yes"</span>, <span class="st">"no"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 428 × 3
   truth    prob estimate_20
   &lt;fct&gt;   &lt;dbl&gt; &lt;fct&gt;      
 1 no    0.0160  no         
 2 no    0.117   no         
 3 no    0.0200  no         
 4 no    0.00231 no         
 5 no    0.00984 no         
 6 no    0.00143 no         
 7 no    0.00507 no         
 8 no    0.0421  no         
 9 no    0.00773 no         
10 no    0.103   no         
# ℹ 418 more rows</code></pre>
</div>
</div>
<hr>
<p>We can now make a confusion matrix for this new set of truth and estimates using the 20% threshold</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>cm_20 <span class="ot">&lt;-</span> preds <span class="sc">|&gt;</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> truth, <span class="at">estimate =</span> estimate_20)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>cm_20</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction yes  no
       yes  35  37
       no   12 344</code></pre>
</div>
</div>
<p>Let’s compare to 50% (original)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>cm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction yes  no
       yes  30  13
       no   17 368</code></pre>
</div>
</div>
<hr>
<p>And let’s compare these two thresholds on a subset of our numeric metrics</p>
<ul>
<li>20% threshold</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>cm_20 <span class="sc">|&gt;</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>, <span class="st">"sens"</span>, <span class="st">"spec"</span>, <span class="st">"ppv"</span>, <span class="st">"npv"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  .metric  .estimate
  &lt;chr&gt;        &lt;dbl&gt;
1 accuracy     0.886
2 sens         0.745
3 spec         0.903
4 ppv          0.486
5 npv          0.966</code></pre>
</div>
</div>
<ul>
<li>50% threshold</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>cm <span class="sc">|&gt;</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>, <span class="st">"sens"</span>, <span class="st">"spec"</span>, <span class="st">"ppv"</span>, <span class="st">"npv"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  .metric  .estimate
  &lt;chr&gt;        &lt;dbl&gt;
1 accuracy     0.930
2 sens         0.638
3 spec         0.966
4 ppv          0.698
5 npv          0.956</code></pre>
</div>
</div>
<p><span class="uwred">Do the changes on each of these metrics make sense to you? If not, please review these previous slides again!</span></p>
<hr>
<p>You can begin to visualize the classifier performance by threshold simply by plotting histograms of the predicted positive class probabilities, separately for the true positive and negative classes</p>
<ul>
<li>Let’s look at our classifier</li>
<li>Ideally, the probabilities are mostly low for the true negative class (“no”) and mostly high for the true positive class (“yes”)</li>
<li>You can imagine how any specific probability cut point would affect specificity (apply cut to the left panel) or sensitivity (apply cut to the right panel)</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> preds, <span class="fu">aes</span>(<span class="at">x =</span> prob)) <span class="sc">+</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(truth), <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">xlab</span>(<span class="st">"Pr(Disease)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question: What do you think about its performance? What insights does this plot generate?
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="fragment uwred">
<ol type="1">
<li><p>You can see that we can likely drop the threshold to somewhere about 25% without decreasing the specificity too much. This will allow you to detect more positive cases.</p></li>
<li><p>Our model seems to be able to predict negative cases well. They mostly have low probabilities. However, you can see its poor performance with positive cases. They are spread pretty evenly across the full range of probabilities. We likely do not have enough positive cases in our training data</p></li>
</ol>
</div>
<hr>
<p>The <strong>Receiver Operating Characteristics (ROC)</strong> curve for a classifier provides a more formal method to visualize the trade-offs between sensitivity and specificity across all possible thresholds for classification.</p>
<p>Lets look at this in our example</p>
<ul>
<li>We need columns for truth and probabilities of the positive class for each observation</li>
<li>We need to specify the positive class</li>
<li>Returns tibble with data to plot an ROC curve</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>roc_plot <span class="ot">&lt;-</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">prob =</span> <span class="fu">predict</span>(fit_glmnet, feat_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes) <span class="sc">|&gt;</span> </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(prob, <span class="at">truth =</span> truth)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>roc_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 202 × 3
    .threshold specificity sensitivity
         &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
 1 -Inf            0                 1
 2    0.000591     0                 1
 3    0.000719     0.00787           1
 4    0.000897     0.0131            1
 5    0.00143      0.0210            1
 6    0.00194      0.0262            1
 7    0.00202      0.0315            1
 8    0.00205      0.0341            1
 9    0.00218      0.0394            1
10    0.00229      0.0446            1
# ℹ 192 more rows</code></pre>
</div>
</div>
<hr>
<p>We can <code>autoplot()</code> this</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(roc_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-39-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Or we can customize a plot passing the data into<code>ggplot()</code></p>
<ul>
<li>Not doing anything fancy here</li>
<li>Consider this a shell for you to build on if you want more than <code>autoplot()</code> provides</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>roc_plot <span class="sc">|&gt;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span> <span class="sc">-</span> specificity, <span class="at">y =</span> sensitivity)) <span class="sc">+</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>() <span class="sc">+</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">lty =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"1 - Specificity (FPR)"</span>,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Sensitivity (TPR)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>When evaluating an ROC curve:</p>
<ul>
<li><p>A random classifier would have a diagonal curve from bottom-left to top-right (the dotted line)</p></li>
<li><p>A perfect classifier would reach up to top-left corner</p>
<ul>
<li>Sensitivity = 1 (true positive rate)</li>
<li>1 - Specificity = 0 (false positive rate)</li>
</ul></li>
</ul>
<hr>
<p>The ROC Curve is not only a useful method to visualize classier performance across thresholds</p>
<p>The area under the ROC curve (auROC) is an attractive performance metric</p>
<ul>
<li>Ranges from 1.0 (perfect) down to approximately 0.5 (random classifier)
<ul>
<li>If the auROC was consistently less than 0.5, then the predictions could simply be inverted</li>
<li>Values between .70 and .80 are considered fair</li>
<li>Values between .80 and .90 are considered good</li>
<li>Values above .90 are considered excellent</li>
<li>These are very rough, and to my eye, the exact cuts and labels are somewhat arbitrary</li>
</ul></li>
</ul>
<hr>
<ul>
<li><p>auROC is the probability that the classifier will rank/predict a randomly selected true positive observation higher than a randomly selected true negative observation</p></li>
<li><p>Alternatively, it can be thought of as the average sensitivity across all decision thresholds</p></li>
<li><p>auROC summarizes performance (sensitivity vs.&nbsp;specificity trade-off) across all possible thresholds</p></li>
<li><p>auROC is not affected by class imbalances in contrast to many other metrics</p></li>
</ul>
<hr>
<p>It is easy to get the auROC for the ROC in tidymodels using <code>roc_auc()</code></p>
<p>As with calculating the ROC curve, we need</p>
<ul>
<li>truth</li>
<li>predicted probabilities for the positive class</li>
<li>to specify the <code>event_level</code> (default is first)</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">prob =</span> <span class="fu">predict</span>(fit_glmnet, feat_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes) <span class="sc">|&gt;</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_auc</span>(prob, <span class="at">truth =</span> truth)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 roc_auc binary         0.896</code></pre>
</div>
</div>
<hr>
</section>
<section id="using-alternative-performance-metrics-for-model-selection" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="using-alternative-performance-metrics-for-model-selection"><span class="header-section-number">8.5</span> Using Alternative Performance Metrics for Model Selection</h2>
<p>You can select the best model configuration using resampling with performance metrics other than accuracy</p>
<ul>
<li><p>Aggregate measures are typically your best choice (except potentially with high imbalance - more on this later)</p>
<ul>
<li>For classification:
<ul>
<li>Accuracy</li>
<li>Balanced accuracy</li>
<li><span class="math inline">\(F1\)</span></li>
<li>Area under ROC Curve (auROC)</li>
<li>Kappa</li>
</ul></li>
<li>For regression
<ul>
<li>RMSE</li>
<li><span class="math inline">\(R^2\)</span></li>
<li>MAE (mean absolute error)</li>
</ul></li>
</ul></li>
</ul>
<hr>
<ul>
<li>You typically need to use a single metric for selection among model configurations
<ul>
<li>You should generally use the performance metric that is the best aligned with your problem:</li>
</ul></li>
<li>In classification
<ul>
<li>Do you care about types of errors or just overall error rate</li>
<li>Is the outcome relatively balanced or unbalanced</li>
<li>What metric will be clearest to your audience</li>
</ul></li>
<li>In regression
<ul>
<li>Do you want to weight big and small errors the same</li>
<li>What metric will be clearest to your audience (though all of these are pretty clear. There are more complicated regression metrics)</li>
</ul></li>
<li>Although you will use one metric to select the best configuration, you can evaluate/characterize the performance of your final model with as many metrics as you like</li>
</ul>
<hr>
<p>You should recognize the differences between the cost function for the algorithm and the performance metric:</p>
<ul>
<li><p>Cost function is fundamental to the definition of the algorithm</p></li>
<li><p>Cost function is minimized to determine parameter estimates in parametric models</p></li>
<li><p>Performance metric is independent of algorithm</p></li>
<li><p>Performance metric is used to select and evaluate model configurations</p></li>
<li><p>Sometimes they can be the same metric (e.g., RMSE)<br>
</p></li>
<li><p>BUT, this is not required</p></li>
</ul>
<hr>
<p>With <code>tidymodels</code>, it is easy to select hyperparameters or select among model configurations more generally using one of many different performance metrics</p>
<ul>
<li>We will still use either <code>tune_grid()</code> or <code>fit_resamples()</code></li>
<li>We will simply specify a different performance metric inside of <code>metric_set()</code></li>
<li>If we only measure one performance metric, we can use defaults with <code>show_best()</code></li>
</ul>
<hr>
<p>Here is an example of measuring <code>roc_auc()</code> but you can use any performance function from the yardstick package</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>fits_glmnet_auc <span class="ot">&lt;-</span> <span class="fu">cache_rds</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> {</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mixture =</span> <span class="fu">tune</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tune_grid</span>(<span class="at">preprocessor =</span> rec, </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">resamples =</span> splits_boot, <span class="at">grid =</span> grid_glmnet, </span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">metrics =</span> <span class="fu">metric_set</span>(roc_auc))</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">rerun =</span> rerun_setting,</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">"cache/008/"</span>,</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits_glmnet_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>And now use <code>show_best()</code>, with best defined by auROC</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(fits_glmnet_auc, <span class="at">n =</span> <span class="dv">5</span>, <span class="at">metric =</span> <span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  penalty mixture .metric .estimator  mean     n std_err .config                
    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                  
1  0.0996       0 roc_auc binary     0.905   100 0.00244 Preprocessor1_Model0104
2  0.0798       0 roc_auc binary     0.905   100 0.00244 Preprocessor1_Model0100
3  0.0844       0 roc_auc binary     0.905   100 0.00244 Preprocessor1_Model0101
4  0.0892       0 roc_auc binary     0.905   100 0.00244 Preprocessor1_Model0102
5  0.0756       0 roc_auc binary     0.905   100 0.00243 Preprocessor1_Model0099</code></pre>
</div>
</div>
<hr>
<p>You can also measure multiple metrics during resampling but you will need to select the best configuration using only one</p>
<ul>
<li>see <code>metric_set()</code> for the measurement of multiple metrics,</li>
<li>see <code>show_best()</code> for the use of <code>metric</code> to indicate which metric to use for selection</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>fits_glmnet_many <span class="ot">&lt;-</span> <span class="fu">cache_rds</span>(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> {</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mixture =</span> <span class="fu">tune</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tune_grid</span>(<span class="at">preprocessor =</span> rec, </span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">resamples =</span> splits_boot, <span class="at">grid =</span> grid_glmnet, </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">metrics =</span> <span class="fu">metric_set</span>(roc_auc, accuracy, sens, spec, bal_accuracy))</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">rerun =</span> rerun_setting,</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">"cache/008/"</span>,</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits_glmnet_many"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>But now we need to indicate how to define <strong>best</strong></p>
<p>We will define it based on balanced accuracy</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(fits_glmnet_many, <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>, <span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
   penalty mixture .metric      .estimator  mean     n std_err
     &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
1 0.000335     0.8 bal_accuracy binary     0.754   100 0.00381
2 0.000355     0.8 bal_accuracy binary     0.754   100 0.00381
3 0.000335     1   bal_accuracy binary     0.754   100 0.00379
4 0.000355     1   bal_accuracy binary     0.754   100 0.00380
5 0.000375     0.8 bal_accuracy binary     0.754   100 0.00380
  .config                
  &lt;chr&gt;                  
1 Preprocessor1_Model0801
2 Preprocessor1_Model0802
3 Preprocessor1_Model1001
4 Preprocessor1_Model1002
5 Preprocessor1_Model0803</code></pre>
</div>
</div>
<p>And here based on auROC (same as before)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(fits_glmnet_many, <span class="at">metric =</span> <span class="st">"roc_auc"</span>, <span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  penalty mixture .metric .estimator  mean     n std_err .config                
    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                  
1  0.0996       0 roc_auc binary     0.905   100 0.00244 Preprocessor1_Model0104
2  0.0798       0 roc_auc binary     0.905   100 0.00244 Preprocessor1_Model0100
3  0.0844       0 roc_auc binary     0.905   100 0.00244 Preprocessor1_Model0101
4  0.0892       0 roc_auc binary     0.905   100 0.00244 Preprocessor1_Model0102
5  0.0756       0 roc_auc binary     0.905   100 0.00243 Preprocessor1_Model0099</code></pre>
</div>
</div>
<hr>
<p>Of course, you can easily calculate any performance metric from <code>yardstick</code> <a href="https://yardstick.tidymodels.org/reference/index.html">package</a> in test to evaluate your final model</p>
<ul>
<li>Using <code>conf_mat()</code> and <code>summary()</code> as above (but not for auROC)</li>
<li>Using <code>*_vec()</code> functions; for example:
<ul>
<li><code>accuracy_vec()</code></li>
<li><code>roc_auc_vec()</code></li>
<li><code>sens_vec()</code>; <code>spec_vec()</code></li>
</ul></li>
<li>Piping a tibble that contain truth, and estimate or probability into appropriate function
<ul>
<li><code>accuracy()</code></li>
<li><code>roc_auc()</code></li>
<li><code>sens()</code>; <code>spec()</code></li>
</ul></li>
</ul>
<hr>
<p>Fit best model using auROC</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>fit_glmnet_auc <span class="ot">&lt;-</span>   </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">select_best</span>(fits_glmnet_many, <span class="at">metric =</span> <span class="st">"roc_auc"</span>)<span class="sc">$</span>penalty, </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">mixture =</span> <span class="fu">select_best</span>(fits_glmnet_many, <span class="at">metric =</span> <span class="st">"roc_auc"</span>)<span class="sc">$</span>mixture) <span class="sc">|&gt;</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>and get all metrics</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>cm_auc <span class="ot">&lt;-</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">predict</span>(fit_glmnet_auc, feat_test)<span class="sc">$</span>.pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(truth, estimate)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>cm_auc <span class="sc">|&gt;</span> </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 3
   .metric              .estimator .estimate
   &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;
 1 accuracy             binary        0.930 
 2 kap                  binary        0.527 
 3 sens                 binary        0.404 
 4 spec                 binary        0.995 
 5 ppv                  binary        0.905 
 6 npv                  binary        0.931 
 7 mcc                  binary        0.578 
 8 j_index              binary        0.399 
 9 bal_accuracy         binary        0.700 
10 detection_prevalence binary        0.0491
11 precision            binary        0.905 
12 recall               binary        0.404 
13 f_meas               binary        0.559 </code></pre>
</div>
</div>
<hr>
<p>Fit best model using balanced accuracy</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>fit_glmnet_bal <span class="ot">&lt;-</span>   </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">select_best</span>(fits_glmnet_many, <span class="at">metric =</span> <span class="st">"roc_auc"</span>)<span class="sc">$</span>penalty, </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">mixture =</span> <span class="fu">select_best</span>(fits_glmnet_many, <span class="at">metric =</span> <span class="st">"roc_auc"</span>)<span class="sc">$</span>mixture) <span class="sc">|&gt;</span> </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> feat_trn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>and still get all metrics (different because best model configuration is different)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>cm_bal <span class="ot">&lt;-</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">predict</span>(fit_glmnet_bal, feat_test)<span class="sc">$</span>.pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(truth, estimate)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>cm_bal <span class="sc">|&gt;</span> </span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 3
   .metric              .estimator .estimate
   &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;
 1 accuracy             binary        0.930 
 2 kap                  binary        0.527 
 3 sens                 binary        0.404 
 4 spec                 binary        0.995 
 5 ppv                  binary        0.905 
 6 npv                  binary        0.931 
 7 mcc                  binary        0.578 
 8 j_index              binary        0.399 
 9 bal_accuracy         binary        0.700 
10 detection_prevalence binary        0.0491
11 precision            binary        0.905 
12 recall               binary        0.404 
13 f_meas               binary        0.559 </code></pre>
</div>
</div>
<hr>
</section>
<section id="advanced-methods-for-class-imbalances" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="advanced-methods-for-class-imbalances"><span class="header-section-number">8.6</span> Advanced Methods for Class Imbalances</h2>
<p>When there is a high degree of class imbalance:</p>
<ul>
<li>It is often difficult to build models that predict the minority class well</li>
<li>This will yield low sensitivity if the positive class is the minority class (as in our example)</li>
<li>This will yield low specificity if the negative class is the minority class</li>
<li>Each of these issues may be a problem depending on the costs of FP and FN</li>
</ul>
<hr>
<p>Let’s see this at play again in our model</p>
<ul>
<li>Using the 50% threshold we have low sensitivity but good specificity</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-51-1.png" style="height:3in" width="672" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>cm <span class="sc">|&gt;</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"sens"</span> <span class="sc">|</span> .metric <span class="sc">==</span> <span class="st">"spec"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  .metric .estimate
  &lt;chr&gt;       &lt;dbl&gt;
1 sens        0.638
2 spec        0.966</code></pre>
</div>
</div>
<hr>
<ul>
<li>We do much better with probabilities for negative (majority) vs.&nbsp;positive (minority) class</li>
<li>We can see that we will not affect specificity much by lowering the threshold for positive classification to 20-25%</li>
<li>BUT, we really need to do do better with the distribution of probabilities for observations that are positive (yes)</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> preds, <span class="fu">aes</span>(<span class="at">x =</span> prob)) <span class="sc">+</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(truth), <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">xlab</span>(<span class="st">"Pr(Disease)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>What can we do when we have imbalanced outcomes?</p>
<p>We will consider:</p>
<ul>
<li>Changes to the classification/decision threshold that trade-off sensitivity vs.&nbsp;specificity for a fitted model (already discussed)</li>
<li>Changes to performance metric for selecting the best model configuration (already demonstrated)</li>
<li>Sampling/Resampling methods that will affect the balance of the outcome in the training data to fit models that are better with the minority class (new)</li>
</ul>
<hr>
<section id="classification-decision-threshold" class="level3" data-number="8.6.1">
<h3 data-number="8.6.1" class="anchored" data-anchor-id="classification-decision-threshold"><span class="header-section-number">8.6.1</span> Classification (Decision) Threshold</h3>
<p>We have already seen an example of how the classification threshold (the probability at which we split between predicting a case as positive vs.&nbsp;negative) affects sensitivity vs.&nbsp;specificity</p>
<p>Decreasing the threshold (probability) for classifying a case as positive will:</p>
<ul>
<li>Increase sensitivity and decrease specificity</li>
<li>This will decrease FN but increase FP</li>
<li>This may be useful if the positive class is the minority class</li>
<li>The ROC curve is a useful display to provide this information about your classifier
<ul>
<li>Curve can be colored to show the threshold</li>
</ul></li>
<li>The separate histograms by positive vs.&nbsp;negative can also be useful as well</li>
<li>If you want to use your data to select the best threshold, you will need yet another set of data to make this selection
<ul>
<li>Can’t make the selection in training b/c those probabilities are overfit</li>
<li>Can’t make the selection of threshold in test and then also use the same test data to evaluate that model!</li>
</ul></li>
</ul>
<hr>
</section>
<section id="performance-metric-considerations" class="level3" data-number="8.6.2">
<h3 data-number="8.6.2" class="anchored" data-anchor-id="performance-metric-considerations"><span class="header-section-number">8.6.2</span> Performance Metric Considerations</h3>
<p>When you are choosing a performance metric for selecting your best model configuration, you should choose a performance metric that it best aligned with the nature of the performance you seek</p>
<ul>
<li>If you want just good overall accuracy, accuracy may be a good metric</li>
<li>If the outcome is unbalanced, and you care about the types of errors, you might want
<ul>
<li>Balanced accuracy (average of sensitive and specificity)</li>
<li>Only sensitivity or specificity by itself (recommended by Kuhn)</li>
<li>auROC</li>
<li>An F measure (harmonic mean of sensitivity and PPV)</li>
<li>May need to think carefully about what is most important to you</li>
</ul></li>
</ul>
<p>Earlier, we saw that we got better sensitivity when we used balanced accuracy rather than accuracy to tune our hyperparameters</p>
<hr>
</section>
<section id="sampling-and-resampling-to-address-class-imbalance" class="level3" data-number="8.6.3">
<h3 data-number="8.6.3" class="anchored" data-anchor-id="sampling-and-resampling-to-address-class-imbalance"><span class="header-section-number">8.6.3</span> Sampling and Resampling to Address Class Imbalance</h3>
<p>We can address issues of class imbalance either a priori or post-hoc with respect to data collection</p>
<ul>
<li><p>A priori method would be to over-sample to get more of the minority class into your training set</p></li>
<li><p>Use targeted recruiting</p></li>
<li><p>Can be very costly or impossible in many instances</p></li>
<li><p>If possible, this can be much better than the resampling approach below</p></li>
<li><p>Post hoc, we can employ a variety of resampling procedures that are designed to make the training data more balanced</p>
<ul>
<li>We can up-sample the minority class</li>
<li>We can down-sample the majority class</li>
<li>We can synthesize new minority class observations e.g, SMOTE</li>
</ul></li>
<li><p>For both a priori sampling or post-hoc resampling strategies, it is important that your test set is not manipulated. It should represent the expected distribution for the outcome, unaltered</p></li>
</ul>
<hr>
</section>
<section id="up-sampling" class="level3" data-number="8.6.4">
<h3 data-number="8.6.4" class="anchored" data-anchor-id="up-sampling"><span class="header-section-number">8.6.4</span> Up-sampling</h3>
<ul>
<li>We resample minority class observations with replacement within our training set to increase the number of total observations of the minority class in the training set.</li>
<li>This simply duplicates existing minority class observations</li>
<li>Our test (or validation) set(s) should NOT be resampled. This is handled well by <code>step_upsample()</code></li>
</ul>
<hr>
<p>Let’s apply this in our example</p>
<ul>
<li>Up-sampling is part of feature engineering recipe</li>
<li>Need to specify the outcome (<code>disease</code>)</li>
<li>Can set <code>over_ratio</code> to values other than 1 if desired</li>
<li>Makes sense to do this after missing data imputation and dummy coding</li>
<li>Makes sense to do this before normalizing features</li>
<li>These steps are in the <code>themis</code> package rather than <code>recipes</code> (can use namespace or load full library)</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>rec_up <span class="ot">&lt;-</span> <span class="fu">recipe</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> data_trn) <span class="sc">|&gt;</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span>   </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  themis<span class="sc">::</span><span class="fu">step_upsample</span>(disease, <span class="at">over_ratio =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Need to re-tune model b/c the sample size has changed</p>
<p>Need to refit the final model to all of train</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>fits_glmnet_up <span class="ot">&lt;-</span> <span class="fu">cache_rds</span>(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> {</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mixture =</span> <span class="fu">tune</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tune_grid</span>(<span class="at">preprocessor =</span> rec_up, </span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">resamples =</span> splits_boot, <span class="at">grid =</span> grid_glmnet, </span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">metrics =</span> <span class="fu">metric_set</span>(bal_accuracy))</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">rerun =</span> rerun_setting,</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">"cache/008/"</span>,</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fit_glmnet_up"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Review hyperparameter plot</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hyperparameters</span>(fits_glmnet_up, <span class="at">hp1 =</span> <span class="st">"penalty"</span>, <span class="at">hp2 =</span> <span class="st">"mixture"</span>, <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>, <span class="at">log_hp1 =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Let’s fit this best model configuration to all of our training data and evaluate it in test</p>
<ul>
<li>Note the use of <code>NULL</code> for <code>new_data</code></li>
<li><code>step_upsample()</code> is only applied to training/held-in but not held-out (truly new) data</li>
<li><code>bake()</code> knows to use the training data provided during <code>prep()</code> if we specify <code>NULL</code></li>
<li>Could have done this all along for baking training. Its sometimes faster but previously same result. Now its necessary!</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>rec_up_prep <span class="ot">&lt;-</span> rec_up <span class="sc">|&gt;</span> </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data_trn)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>feat_trn_up <span class="ot">&lt;-</span> rec_up_prep <span class="sc">|&gt;</span> </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Notice that <code>disease</code> is now balanced in the training data!</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>feat_trn_up <span class="sc">|&gt;</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skim_all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">feat_trn_up</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">1522</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">17</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">disease</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">yes: 761, no: 761</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 27%">
<col style="width: 9%">
<col style="width: 13%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: right;">skew</th>
<th style="text-align: right;">kurtosis</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.82</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">2.42</td>
<td style="text-align: right;">-0.31</td>
<td style="text-align: right;">-0.53</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_bp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.19</td>
<td style="text-align: right;">-0.73</td>
<td style="text-align: right;">-0.17</td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">3.32</td>
<td style="text-align: right;">0.55</td>
<td style="text-align: right;">0.40</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chol</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.36</td>
<td style="text-align: right;">-0.72</td>
<td style="text-align: right;">-0.08</td>
<td style="text-align: right;">0.64</td>
<td style="text-align: right;">6.11</td>
<td style="text-align: right;">1.03</td>
<td style="text-align: right;">3.51</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_max_hr</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.63</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.71</td>
<td style="text-align: right;">2.25</td>
<td style="text-align: right;">-0.49</td>
<td style="text-align: right;">-0.23</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_depress</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.94</td>
<td style="text-align: right;">-0.94</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">4.05</td>
<td style="text-align: right;">1.07</td>
<td style="text-align: right;">0.84</td>
</tr>
<tr class="even">
<td style="text-align: left;">ca</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">2.53</td>
<td style="text-align: right;">1.16</td>
<td style="text-align: right;">0.25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sex_male</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.49</td>
<td style="text-align: right;">-1.49</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">-0.82</td>
<td style="text-align: right;">-1.33</td>
</tr>
<tr class="even">
<td style="text-align: left;">cp_atyp_ang</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: right;">2.24</td>
<td style="text-align: right;">1.79</td>
<td style="text-align: right;">1.21</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cp_non_anginal</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.76</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">-1.20</td>
<td style="text-align: right;">-0.57</td>
</tr>
<tr class="even">
<td style="text-align: left;">fbs_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">2.40</td>
<td style="text-align: right;">1.98</td>
<td style="text-align: right;">1.93</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rest_ecg_wave_abn</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">8.45</td>
<td style="text-align: right;">8.33</td>
<td style="text-align: right;">67.40</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_ecg_ventric_hypertrophy</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">1.04</td>
<td style="text-align: right;">1.04</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">-1.99</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_ang_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">1.48</td>
<td style="text-align: right;">1.48</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">-1.37</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_st_slope_flat</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.97</td>
<td style="text-align: right;">-0.97</td>
<td style="text-align: right;">-0.97</td>
<td style="text-align: right;">1.03</td>
<td style="text-align: right;">1.03</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">-2.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_slope_downslope</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">4.36</td>
<td style="text-align: right;">4.13</td>
<td style="text-align: right;">15.06</td>
</tr>
<tr class="even">
<td style="text-align: left;">thal_fixeddefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">5.02</td>
<td style="text-align: right;">4.82</td>
<td style="text-align: right;">21.25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">thal_reversabledefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.82</td>
<td style="text-align: right;">-0.82</td>
<td style="text-align: right;">-0.82</td>
<td style="text-align: right;">1.22</td>
<td style="text-align: right;">1.22</td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">-1.84</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>fit_glmnet_up <span class="ot">&lt;-</span>   </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">select_best</span>(fits_glmnet_up, <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>)<span class="sc">$</span>penalty, </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">mixture =</span> <span class="fu">select_best</span>(fits_glmnet_up, <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>)<span class="sc">$</span>mixture) <span class="sc">|&gt;</span> </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> feat_trn_up)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>To evaluate this model, we now need test features too</p>
<ul>
<li>IMPORTANT: Test is NOT up-sampled</li>
<li>bake it as new data!</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>feat_test <span class="ot">&lt;-</span> rec_up_prep <span class="sc">|&gt;</span> </span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(data_test)  </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>feat_test <span class="sc">|&gt;</span> <span class="fu">skim_all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">feat_test</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">428</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">17</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">disease</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">no: 381, yes: 47</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 26%">
<col style="width: 9%">
<col style="width: 12%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: right;">skew</th>
<th style="text-align: right;">kurtosis</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.07</td>
<td style="text-align: right;">1.06</td>
<td style="text-align: right;">-2.26</td>
<td style="text-align: right;">-1.03</td>
<td style="text-align: right;">-0.14</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">2.53</td>
<td style="text-align: right;">0.14</td>
<td style="text-align: right;">-0.75</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_bp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">0.91</td>
<td style="text-align: right;">-2.19</td>
<td style="text-align: right;">-0.73</td>
<td style="text-align: right;">-0.17</td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">3.78</td>
<td style="text-align: right;">0.69</td>
<td style="text-align: right;">1.13</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chol</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.10</td>
<td style="text-align: right;">1.02</td>
<td style="text-align: right;">-2.36</td>
<td style="text-align: right;">-0.76</td>
<td style="text-align: right;">-0.27</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">6.11</td>
<td style="text-align: right;">1.99</td>
<td style="text-align: right;">8.98</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_max_hr</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right;">0.89</td>
<td style="text-align: right;">-3.35</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.88</td>
<td style="text-align: right;">1.91</td>
<td style="text-align: right;">-0.73</td>
<td style="text-align: right;">0.32</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_depress</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.26</td>
<td style="text-align: right;">0.89</td>
<td style="text-align: right;">-0.94</td>
<td style="text-align: right;">-0.94</td>
<td style="text-align: right;">-0.58</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">4.59</td>
<td style="text-align: right;">1.69</td>
<td style="text-align: right;">3.29</td>
</tr>
<tr class="even">
<td style="text-align: left;">ca</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.33</td>
<td style="text-align: right;">0.82</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">2.53</td>
<td style="text-align: right;">2.05</td>
<td style="text-align: right;">3.44</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sex_male</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">1.06</td>
<td style="text-align: right;">-1.49</td>
<td style="text-align: right;">-1.49</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">-0.39</td>
<td style="text-align: right;">-1.85</td>
</tr>
<tr class="even">
<td style="text-align: left;">cp_atyp_ang</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">1.08</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: right;">2.24</td>
<td style="text-align: right;">1.49</td>
<td style="text-align: right;">0.21</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cp_non_anginal</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.11</td>
<td style="text-align: right;">1.06</td>
<td style="text-align: right;">-1.76</td>
<td style="text-align: right;">-1.76</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">-0.92</td>
<td style="text-align: right;">-1.15</td>
</tr>
<tr class="even">
<td style="text-align: left;">fbs_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.05</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">2.40</td>
<td style="text-align: right;">2.18</td>
<td style="text-align: right;">2.77</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rest_ecg_wave_abn</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">8.45</td>
<td style="text-align: right;">8.24</td>
<td style="text-align: right;">66.02</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_ecg_ventric_hypertrophy</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.08</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">1.04</td>
<td style="text-align: right;">1.04</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">-1.95</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_ang_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.22</td>
<td style="text-align: right;">0.88</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">1.48</td>
<td style="text-align: right;">1.40</td>
<td style="text-align: right;">-0.04</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_st_slope_flat</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: right;">-0.97</td>
<td style="text-align: right;">-0.97</td>
<td style="text-align: right;">-0.97</td>
<td style="text-align: right;">1.03</td>
<td style="text-align: right;">1.03</td>
<td style="text-align: right;">0.53</td>
<td style="text-align: right;">-1.72</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_slope_downslope</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">1.19</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">4.36</td>
<td style="text-align: right;">3.29</td>
<td style="text-align: right;">8.83</td>
</tr>
<tr class="even">
<td style="text-align: left;">thal_fixeddefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">1.02</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">5.02</td>
<td style="text-align: right;">4.70</td>
<td style="text-align: right;">20.11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">thal_reversabledefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.32</td>
<td style="text-align: right;">0.88</td>
<td style="text-align: right;">-0.82</td>
<td style="text-align: right;">-0.82</td>
<td style="text-align: right;">-0.82</td>
<td style="text-align: right;">-0.82</td>
<td style="text-align: right;">1.22</td>
<td style="text-align: right;">1.17</td>
<td style="text-align: right;">-0.64</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
<p>Let’s see how this model performs in test</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>cm_up <span class="ot">&lt;-</span> </span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">predict</span>(fit_glmnet_up, feat_test)<span class="sc">$</span>.pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(truth, estimate)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>cm_up <span class="sc">|&gt;</span> </span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 3
   .metric              .estimator .estimate
   &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;
 1 accuracy             binary         0.806
 2 kap                  binary         0.390
 3 sens                 binary         0.830
 4 spec                 binary         0.803
 5 ppv                  binary         0.342
 6 npv                  binary         0.975
 7 mcc                  binary         0.448
 8 j_index              binary         0.633
 9 bal_accuracy         binary         0.816
10 detection_prevalence binary         0.266
11 precision            binary         0.342
12 recall               binary         0.830
13 f_meas               binary         0.484</code></pre>
</div>
</div>
<hr>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>preds_up <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">prob =</span> <span class="fu">predict</span>(fit_glmnet_up, feat_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> preds_up, <span class="fu">aes</span>(<span class="at">x =</span> prob)) <span class="sc">+</span> </span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(truth), <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">xlab</span>(<span class="st">"Pr(Disease)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="down-sampling" class="level3" data-number="8.6.5">
<h3 data-number="8.6.5" class="anchored" data-anchor-id="down-sampling"><span class="header-section-number">8.6.5</span> Down-sampling</h3>
<p>We resample majority class observations within our training set to decrease/match the number of total observations of the minority class in the training set.</p>
<ul>
<li>This selects a subset of the majority class</li>
<li>Our test (or validation) set(s) should NOT be resampled. This is handled well by <code>step_downsample()</code></li>
</ul>
<hr>
<p>Down-sampling is part of feature engineering recipe</p>
<ul>
<li>Need to specify the outcome (<code>disease</code>)</li>
<li>Can set <code>under_ratio</code> to values other than 1 if desired</li>
<li>Makes sense to do this after missing data imputation and dummy coding</li>
<li>Makes sense to do this before normalizing features</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>rec_down <span class="ot">&lt;-</span> <span class="fu">recipe</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> data_trn) <span class="sc">|&gt;</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span>   </span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>  themis<span class="sc">::</span><span class="fu">step_downsample</span>(disease, <span class="at">under_ratio =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Need to re-tune model b/c the sample size has changed</p>
<p>Need to refit the final model to all of train</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>fits_glmnet_down <span class="ot">&lt;-</span> <span class="fu">cache_rds</span>(</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> {</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mixture =</span> <span class="fu">tune</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tune_grid</span>(<span class="at">preprocessor =</span> rec_down, </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">resamples =</span> splits_boot, <span class="at">grid =</span> grid_glmnet, </span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">metrics =</span> <span class="fu">metric_set</span>(bal_accuracy))</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">rerun =</span> rerun_setting,</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">"cache/008/"</span>,</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits_glmnet_down"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Review hyperparameters</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hyperparameters</span>(fits_glmnet_down, <span class="at">hp1 =</span> <span class="st">"penalty"</span>, <span class="at">hp2 =</span> <span class="st">"mixture"</span>, </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>, <span class="at">log_hp1 =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Let’s fit this best model configuration to all of our training data and evaluate it in test</p>
<ul>
<li>Note the use of <code>NULL</code> again when getting features for training data. Very important!</li>
<li><code>step_downsample()</code> is not applied to baked data (See its default for <code>skip = TRUE</code> argument)</li>
<li>NOTE: sample size and ratio of yes/now for disease!</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>rec_down_prep <span class="ot">&lt;-</span> rec_down <span class="sc">|&gt;</span> </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data_trn)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>feat_trn_down <span class="ot">&lt;-</span> rec_down_prep <span class="sc">|&gt;</span> </span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>feat_trn_down <span class="sc">|&gt;</span> <span class="fu">skim_some</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">feat_trn_down</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">184</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">17</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 14%">
<col style="width: 19%">
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">disease</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">yes: 92, no: 92</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p100</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.85</td>
<td style="text-align: right;">2.16</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_bp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.89</td>
<td style="text-align: right;">3.50</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chol</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.52</td>
<td style="text-align: right;">3.34</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_max_hr</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.56</td>
<td style="text-align: right;">2.16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_depress</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.87</td>
<td style="text-align: right;">4.24</td>
</tr>
<tr class="even">
<td style="text-align: left;">ca</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">2.46</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sex_male</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.55</td>
<td style="text-align: right;">0.64</td>
</tr>
<tr class="even">
<td style="text-align: left;">cp_atyp_ang</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.47</td>
<td style="text-align: right;">2.09</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cp_non_anginal</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.78</td>
<td style="text-align: right;">0.56</td>
</tr>
<tr class="even">
<td style="text-align: left;">fbs_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.47</td>
<td style="text-align: right;">2.09</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rest_ecg_wave_abn</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.10</td>
<td style="text-align: right;">9.51</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_ecg_ventric_hypertrophy</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.99</td>
<td style="text-align: right;">1.01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_ang_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.64</td>
<td style="text-align: right;">1.55</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_st_slope_flat</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.84</td>
<td style="text-align: right;">1.19</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_slope_downslope</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.21</td>
<td style="text-align: right;">4.68</td>
</tr>
<tr class="even">
<td style="text-align: left;">thal_fixeddefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.17</td>
<td style="text-align: right;">5.97</td>
</tr>
<tr class="odd">
<td style="text-align: left;">thal_reversabledefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.79</td>
<td style="text-align: right;">1.26</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
<p>Now fit the model to these downsampled training data</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>fit_glmnet_down <span class="ot">&lt;-</span>   </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">select_best</span>(fits_glmnet_down, <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>)<span class="sc">$</span>penalty, </span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">mixture =</span> <span class="fu">select_best</span>(fits_glmnet_down, <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>)<span class="sc">$</span>mixture) <span class="sc">|&gt;</span> </span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> feat_trn_down)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Let’s see how this model performs in test</p>
<ul>
<li>First we need test features</li>
<li>IMPORTANT: Test is NOT down-sampled</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>feat_test <span class="ot">&lt;-</span> rec_down_prep <span class="sc">|&gt;</span> </span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(data_test)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>feat_test <span class="sc">|&gt;</span> <span class="fu">skim_some</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">feat_test</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">428</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">17</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 19%">
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">disease</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">no: 381, yes: 47</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p100</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.29</td>
<td style="text-align: right;">2.49</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_bp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.25</td>
<td style="text-align: right;">3.97</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chol</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.52</td>
<td style="text-align: right;">6.30</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_max_hr</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-3.27</td>
<td style="text-align: right;">1.83</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_depress</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.87</td>
<td style="text-align: right;">4.78</td>
</tr>
<tr class="even">
<td style="text-align: left;">ca</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">2.46</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sex_male</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.55</td>
<td style="text-align: right;">0.64</td>
</tr>
<tr class="even">
<td style="text-align: left;">cp_atyp_ang</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.47</td>
<td style="text-align: right;">2.09</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cp_non_anginal</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.78</td>
<td style="text-align: right;">0.56</td>
</tr>
<tr class="even">
<td style="text-align: left;">fbs_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.47</td>
<td style="text-align: right;">2.09</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rest_ecg_wave_abn</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.10</td>
<td style="text-align: right;">9.51</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_ecg_ventric_hypertrophy</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.99</td>
<td style="text-align: right;">1.01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_ang_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.64</td>
<td style="text-align: right;">1.55</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_st_slope_flat</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.84</td>
<td style="text-align: right;">1.19</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_slope_downslope</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.21</td>
<td style="text-align: right;">4.68</td>
</tr>
<tr class="even">
<td style="text-align: left;">thal_fixeddefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.17</td>
<td style="text-align: right;">5.97</td>
</tr>
<tr class="odd">
<td style="text-align: left;">thal_reversabledefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.79</td>
<td style="text-align: right;">1.26</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
<p>Get metrics in test</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>cm_down <span class="ot">&lt;-</span> </span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">predict</span>(fit_glmnet_down, feat_test)<span class="sc">$</span>.pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(truth, estimate)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>cm_down <span class="sc">|&gt;</span> </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 3
   .metric              .estimator .estimate
   &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;
 1 accuracy             binary         0.806
 2 kap                  binary         0.390
 3 sens                 binary         0.830
 4 spec                 binary         0.803
 5 ppv                  binary         0.342
 6 npv                  binary         0.975
 7 mcc                  binary         0.448
 8 j_index              binary         0.633
 9 bal_accuracy         binary         0.816
10 detection_prevalence binary         0.266
11 precision            binary         0.342
12 recall               binary         0.830
13 f_meas               binary         0.484</code></pre>
</div>
</div>
<hr>
<p>And plot faceted probabilites</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>preds_down <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">prob =</span> <span class="fu">predict</span>(fit_glmnet_down, feat_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> preds_down, <span class="fu">aes</span>(<span class="at">x =</span> prob)) <span class="sc">+</span> </span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(truth), <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">xlab</span>(<span class="st">"Pr(Disease)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/u8-bal-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="smote" class="level3" data-number="8.6.6">
<h3 data-number="8.6.6" class="anchored" data-anchor-id="smote"><span class="header-section-number">8.6.6</span> SMOTE</h3>
<p>A third approach to resampling is called the synthetic minority over-sampling technique (SMOTE)</p>
<p>To up-sample the minority class, SMOTE synthesizes new observations.</p>
<ul>
<li>To do this, an observation is randomly selected from the minority class.<br>
</li>
<li>This observation’s K-nearest neighbors (KNNs) are then determined.</li>
<li>The new synthetic observation retains the outcome but a random combination of the predictors values from the randomly selected observation and its neighbors.</li>
</ul>
<hr>
<p>This is easily implemented by recipe in <code>tidymodels</code> using <code>step_smote()</code></p>
<ul>
<li>Need to specify the outcome (<code>disease</code>)</li>
<li>Can set <code>over_ratio</code> to values other than 1 (default) if desired</li>
<li>Can set <code>neighbors</code> to values other than 5 (default) if desired</li>
<li>Makes sense to do this after missing data imputation and dummy coding</li>
<li>Other features will need to be scaled/range-corrected prior to use (for distance)</li>
<li>Makes sense to do this before normalizing features for glmnet, etc</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>rec_smote <span class="ot">&lt;-</span> <span class="fu">recipe</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> data_trn) <span class="sc">|&gt;</span> </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span>   </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_range</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>  themis<span class="sc">::</span><span class="fu">step_smote</span>(disease, <span class="at">over_ratio =</span> <span class="dv">1</span>, <span class="at">neighbors =</span> <span class="dv">5</span>) <span class="sc">|&gt;</span> </span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Need to re-tune model b/c the sample size has changed</p>
<p>Need to refit the final model to all of train</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>fits_glmnet_smote <span class="ot">&lt;-</span> <span class="fu">cache_rds</span>(</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> {</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mixture =</span> <span class="fu">tune</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tune_grid</span>(<span class="at">preprocessor =</span> rec_smote, </span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">resamples =</span> splits_boot, <span class="at">grid =</span> grid_glmnet, </span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">metrics =</span> <span class="fu">metric_set</span>(bal_accuracy))</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">rerun =</span> rerun_setting,</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">"cache/008/"</span>,</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fits_glmnet_smote"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Review hyperparameters</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hyperparameters</span>(fits_glmnet_smote, <span class="at">hp1 =</span> <span class="st">"penalty"</span>, <span class="at">hp2 =</span> <span class="st">"mixture"</span>, </span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>, <span class="at">log_hp1 =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p>Let’s fit this best model configuration to all of our training data and evaluate it in test</p>
<ul>
<li>Note the use of <code>NULL</code> (once again!) for <code>new_data</code></li>
<li><code>step_smote()</code> is not applied to new data</li>
<li>NOTE: sample size and outcome balance</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>rec_smote_prep <span class="ot">&lt;-</span> rec_smote <span class="sc">|&gt;</span> </span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(data_trn)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>feat_trn_smote <span class="ot">&lt;-</span> rec_smote_prep <span class="sc">|&gt;</span> </span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="cn">NULL</span>)</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>feat_trn_smote <span class="sc">|&gt;</span> <span class="fu">skim_some</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">feat_trn_smote</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">1522</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">18</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">17</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 19%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">disease</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">yes: 761, no: 761</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p100</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.97</td>
<td style="text-align: right;">2.57</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_bp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.38</td>
<td style="text-align: right;">3.72</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chol</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.51</td>
<td style="text-align: right;">6.44</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_max_hr</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-2.84</td>
<td style="text-align: right;">2.42</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_depress</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.00</td>
<td style="text-align: right;">4.71</td>
</tr>
<tr class="even">
<td style="text-align: left;">ca</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.78</td>
<td style="text-align: right;">2.73</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sex_male</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.60</td>
<td style="text-align: right;">0.64</td>
</tr>
<tr class="even">
<td style="text-align: left;">cp_atyp_ang</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: right;">2.29</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cp_non_anginal</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.81</td>
<td style="text-align: right;">0.57</td>
</tr>
<tr class="even">
<td style="text-align: left;">fbs_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">2.52</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rest_ecg_wave_abn</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.11</td>
<td style="text-align: right;">11.37</td>
</tr>
<tr class="even">
<td style="text-align: left;">rest_ecg_ventric_hypertrophy</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.98</td>
<td style="text-align: right;">1.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_ang_yes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">1.50</td>
</tr>
<tr class="even">
<td style="text-align: left;">exer_st_slope_flat</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.97</td>
<td style="text-align: right;">1.06</td>
</tr>
<tr class="odd">
<td style="text-align: left;">exer_st_slope_downslope</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.24</td>
<td style="text-align: right;">4.71</td>
</tr>
<tr class="even">
<td style="text-align: left;">thal_fixeddefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.19</td>
<td style="text-align: right;">5.75</td>
</tr>
<tr class="odd">
<td style="text-align: left;">thal_reversabledefect</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.89</td>
<td style="text-align: right;">1.18</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
<p>Fit model to smote sampled training data</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>fit_glmnet_smote <span class="ot">&lt;-</span>   </span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">select_best</span>(fits_glmnet_smote, <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>)<span class="sc">$</span>penalty, </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">mixture =</span> <span class="fu">select_best</span>(fits_glmnet_smote, <span class="at">metric =</span> <span class="st">"bal_accuracy"</span>)<span class="sc">$</span>mixture) <span class="sc">|&gt;</span> </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(disease <span class="sc">~</span> ., <span class="at">data =</span> feat_trn_smote)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p>Let’s see how this model performs in test</p>
<ul>
<li>IMPORTANT: Test is NOT SMOTE up-sampled</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>feat_test <span class="ot">&lt;-</span> rec_smote_prep <span class="sc">|&gt;</span> </span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(data_test)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>cm_smote <span class="ot">&lt;-</span> </span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">predict</span>(fit_glmnet_smote, feat_test)<span class="sc">$</span>.pred_class) <span class="sc">|&gt;</span> </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(truth, estimate)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>cm_smote <span class="sc">|&gt;</span> </span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 3
   .metric              .estimator .estimate
   &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;
 1 accuracy             binary         0.811
 2 kap                  binary         0.390
 3 sens                 binary         0.809
 4 spec                 binary         0.811
 5 ppv                  binary         0.345
 6 npv                  binary         0.972
 7 mcc                  binary         0.443
 8 j_index              binary         0.620
 9 bal_accuracy         binary         0.810
10 detection_prevalence binary         0.257
11 precision            binary         0.345
12 recall               binary         0.809
13 f_meas               binary         0.484</code></pre>
</div>
</div>
<hr>
<p>Plot faceted predicted probabilites</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>preds_smote <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">truth =</span> feat_test<span class="sc">$</span>disease,</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">prob =</span> <span class="fu">predict</span>(fit_glmnet_smote, feat_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> preds_smote, <span class="fu">aes</span>(<span class="at">x =</span> prob)) <span class="sc">+</span> </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(truth), <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">xlab</span>(<span class="st">"Pr(Disease)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="l08_advanced_performance_metrics_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Landis1977" class="csl-entry" role="listitem">
Landis, J. R., and G. G. Koch. 1977. <span>“The Measurement of Observer Agreement for Categorical Data.”</span> <em>Biometrics</em> 33 (1): 159–74.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.io\/jjcurtin\/book_iaml");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./l07_midterm.html" class="pagination-link" aria-label="Midterm Exam">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Midterm Exam</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./l09_random_forest.html" class="pagination-link" aria-label="Advanced Models: Decision Trees, Bagging Trees, and Random Forest">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced Models: Decision Trees, Bagging Trees, and Random Forest</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/jjcurtin/book_iaml/edit/main/l08_advanced_performance_metrics.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>